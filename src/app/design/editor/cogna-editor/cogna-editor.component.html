<style>
  input[type=search].start {
    /* background: rgba(255, 255, 255, .7) url(assets/img/search-icon.png) no-repeat 9px center; */
    background: #ccc url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>') no-repeat 8px center;
    background-size: 20px 16px;
    border: none;
    padding: 6px 10px 6px 32px;
    vertical-align: middle;
    border-radius: 10em;
    color: black;
    max-width: 100%;
  }

  input[type=search].start:focus {
    border-color: #0078d7;
    outline: none;
    -webkit-box-shadow: 0 0 5px rgba(109, 207, 246, .5);
    -moz-box-shadow: 0 0 5px rgba(109, 207, 246, .5);
    box-shadow: 0 0 5px rgba(109, 207, 246, .5);
  }
</style>
<div class="wrapper" split-pane>
  <div class="sidebar bg-white" sidebar #sidebar>
    <div class="p-3">
      <h5 class="mb-3">Cogna Manager</h5>
      <input type="search" class="start" placeholder="Filter list" autocapitalize="none"
        (keyup.enter)="loadCognaList(1)" [(ngModel)]="searchText">
    </div>
    <div class="group-list">
      @if (itemLoading) {
      <div class="p-3 text-center">
        <div class="lds-ellipsis white">
          <div></div>
          <div></div>
          <div></div>
          <div></div>
        </div>
      </div>
      }@else {
      <div class="mb-3">
        @for (a of cognaList | filter:searchText; track a.id) {
        <a class="pointer element" [routerLink]="['/design',appId,'cogna']" [queryParams]="{id:a?.id}"
          [class.active]="a.id==cognaId" routerLinkActive="active">
          <div class="list-group-item-heading">
            {{a.name}} <sup>{{a?.id}}</sup>
          </div>
          @if (a.description) {
          <div class="list-group-item-text">{{a.description}}</div>
          }
        </a>
        }
        <a class="pointer element"
          (click)="editCogna(editCognaTpl,{type:'txtgen', embedModelType:'e5small', embedModelName:'', embedModelApiKey:'', chunkLength:100, chunkOverlap:10, embedMaxResult:5, inferModelType:'openai', inferModelName:'gpt-4o-mini', inferModelApiKey:'demo', temperature:0.0, maxChatMemory:5, vectorStoreType:'inmemory', systemMessage:defaultSysMsg, data:{}}, true)"
          [class.disabled]="offline">
          <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
          Create Cogna
        </a>
        <div class="p-2 pagination-rounded">
          @if (cognaTotal>itemsPerPage) {
          <ngb-pagination [collectionSize]="cognaTotal" [pageSize]="itemsPerPage" [(page)]="pageNumber" [maxSize]="5"
            (pageChange)="loadCognaList(pageNumber)" [boundaryLinks]="false" [directionLinks]="false">
            <ng-template ngbPaginationFirst>
              <fa-icon [icon]="['fas','angle-double-left']"></fa-icon>
            </ng-template>
            <ng-template ngbPaginationPrevious>
              <fa-icon [icon]="['fas','chevron-left']"></fa-icon>
            </ng-template>
            <ng-template ngbPaginationNext>
              <fa-icon [icon]="['fas','chevron-right']"></fa-icon>
            </ng-template>
            <ng-template ngbPaginationLast>
              <fa-icon [icon]="['fas','angle-double-right']"></fa-icon>
            </ng-template>
          </ngb-pagination>
          }
          <div class="clearfix"></div>
        </div>
      </div>
      }
    </div>
  </div>
  <div class="content" content>
    <div class="p-2">
      @if (cogna) {
      <div>
        <div class="limit-widthx">
          <div class="me-auto d-flex flex-row w-100 py-2">
            <h5 class="m-0 text-truncate">{{cogna.name}}</h5>
            @if (cogna.description) {
            <div class="ms-2 text-truncate align-bottom text-muted">
              {{cogna.description}}</div>
            }
          </div>
          <div class="text-muted mb-2">
            <small>Cogna ID : {{cogna.id}}</small>
          </div>

          @if (cogna && (cogna.app?.id == appId)) {
          <div class="d-flex flex-row mt-2">
            @if (cogna.email.indexOf(user.email)>-1) {
            <div ngbDropdown>
              <button type="button" class="btn btn-sm border border-2" id="cognaEditor" ngbDropdownToggle>
                <fa-icon [icon]="['fas','link']" [fixedWidth]="true"></fa-icon>
              </button>
              <div ngbDropdownMenu aria-labelledby="cognaEditor" style="min-width:340px">
                <div class="px-2" [class.text-danger]="!cogna.publicAccess">
                  @if (cogna.publicAccess) {
                  <fa-icon [icon]="['fas','globe']" [fixedWidth]="true">
                  </fa-icon>
                  }@else{
                  <fa-icon [icon]="['fas','lock']" [fixedWidth]="true">
                  </fa-icon>
                  }
                  {{cogna.publicAccess?'Public Cogna': 'Private Cogna'}}
                </div>
                <div class="dropdown-divider"></div>
                <div class="px-2">
                  <label class="small">Cogna Endpoint</label>
                  <input name="endpointUrl"
                    onclick="this.setSelectionRange(0, this.value.length);document.execCommand('copy')" type="text"
                    class="form-control border-0 bg-light small"
                    value="{{cogna.code? base+'/~cogna/'+cogna.code+'/'+cognaEp[cogna.type]:baseApi+'/cogna/'+cogna.id+'/'+cognaEp[cogna.type]}}"
                    readonly>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm border border-2 btn-outline-secondary ms-1"
              (click)="editCogna(editCognaTpl,cogna,false)" [class.disabled]="offline">
              <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true"></fa-icon>
            </button>
            <button type="button" class="btn btn-sm border border-2 btn-outline-secondary ms-1"
              title="Re-initialize models" (click)="reinitCogna(cogna)" [class.disabled]="offline">
              <fa-icon [icon]="['fas','sync']" [fixedWidth]="true"></fa-icon>
            </button>
            <button type="button" class="btn btn-sm border border-2 btn-outline-secondary ms-1" title="Search vector DB"
              (click)="openSearchDb(searchDbTpl, cogna)" [class.disabled]="offline">
              <fa-icon [icon]="['fas','list-ol']" [fixedWidth]="true"></fa-icon>
            </button>
            <button type="button" class="btn btn-sm border border-2 btn-outline-secondary ms-1" title="Chat history"
              (click)="viewChatHistory(viewChatHistoryTpl, cogna)" [class.disabled]="offline">
              <fa-icon [icon]="['far','clock']" [fixedWidth]="true"></fa-icon>
            </button>
            <button type="button" class="btn btn-sm border border-2 btn-outline-danger ms-1"
              (click)="removeCogna(removeCognaTpl,cogna)" [class.disabled]="offline">
              <fa-icon [icon]="['fas','trash']" [fixedWidth]="true"></fa-icon>
            </button>
            } @else {
            <div class="bg-warning p-1 small">
              Interactive access and modification only available for <i>{{cogna.email}}</i>
            </div>
            }
          </div>
          }
        </div>
        @if (loading) {
        <div class="p-4 text-center">
          <div class="lds-ellipsis">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
          </div>
        </div>
        }
        <div class="row g-2 mt-1">
          <div class="col-sm-4 col-lg-3">
            @if(['txtgen'].includes(cogna.type)){
            <div class="card overflow-hidden border border-2 mb-2">
              <div class="card-header p-2">
                <div class="text-muted text-strong col">Embedding</div>
              </div>
              <div class="list-group list-group-flush">
                <div class="list-group-item">
                  @if (cogna.embedModelType=='minilm'){
                  All-MiniLM (built-in)
                  }@else if(cogna.embedModelType=='e5small'){
                  Multilingual E5-Small-V2 (built-in)
                  }@else if(cogna.embedModelType=='e5large'){
                  E5-Large-V2 (built-in)
                  }@else{
                  <div class="small text-muted">{{embedModelTypeMap[cogna.embedModelType]?.name}}</div>
                  <div>{{cogna.embedModelName}}</div>
                  }
                </div>
              </div>

              <div class="card-body bg-light small p-2">
                Chunk: {{cogna.chunkLength}}, Overlap: {{cogna.chunkOverlap}}
              </div>
            </div>
            }
            @if(['txtgen','txtext','imggen','imgcls'].includes(cogna.type) || (['txtcls'].includes(cogna.type) &&
            cogna.data?.txtclsLlm)){
            <div class="card overflow-hidden border border-2 mb-2">
              <div class="card-header p-2">
                <div class="text-muted text-strong col">Inference</div>
              </div>
              <div class="list-group list-group-flush">
                <div class="list-group-item">
                  <div class="small text-muted">
                    {{embedModelTypeMap[cogna.inferModelType]?.name}}
                  </div>
                  <div>{{cogna.inferModelName}}</div>
                </div>
                @if(['imggen'].includes(cogna.type)){
                <!-- <div class="list-group-item">
                        <div class="small text-muted">
                          Quality
                        </div>
                        <div>{{cogna.data?.imgQuality}}</div>
                      </div> -->
                <div class="list-group-item">
                  <div class="small text-muted">
                    Size
                  </div>
                  <div>{{cogna.data?.imgSize}}</div>
                </div>
                <!-- <div class="list-group-item">
                        <div class="small text-muted">
                          Style
                        </div>
                        <div>{{cogna.data?.imgStyle}}</div>
                      </div> -->
                @if (cogna.data?.genBucket){
                <div class="list-group-item">
                  <div class="small text-muted">
                    Generated image saved to
                  </div>
                  <div>Bucket: <strong>{{cogna.data?.genBucketId}} </strong> <a
                      [routerLink]="['../../'+app?.id+'/bucket']" [queryParams]="{id:cogna.data?.genBucketId}">View
                      Bucket</a></div>
                </div>
                }
                }
                @if(['imgcls'].includes(cogna.type)){
                <div class="list-group-item">
                  <div class="small text-muted">
                    Min Score
                  </div>
                  <div>{{cogna.data?.imgclsMinScore}}</div>
                </div>
                <div class="list-group-item">
                  <div class="small text-muted">
                    Limit Result
                  </div>
                  <div>{{cogna.data?.imgclsLimit}}</div>
                </div>
                }
              </div>
              @if(['txtgen'].includes(cogna.type)){
              <div class="card-body bg-light small p-2">
                Temperature: {{cogna.temperature}}, Max Memory: {{cogna.maxChatMemory}}
              </div>
              }
            </div>
            }

            @if(['txtext'].includes(cogna.type)){
            <div class="card overflow-hidden border border-2 mb-2">
              <div class="card-header p-2">
                <div class="text-muted text-strong col">Fields to extract</div>
              </div>
              <!-- <div class="list-group list-group-flush">
                    @for(i of getAsList(cogna.data.extractField); track i){
                      <div class="list-group-item">
                        <div>{{i}}</div>
                      </div>
                    }
                  </div> -->
              <div class="list-group list-group-flush">
                @for(i of extractJsonObj|keyvalue; track $index){
                <div class="list-group-item p-2">
                  @if(['object','array'].includes(i.value?.type)){
                  <button type="button" class="btn btn-xs btn-light float-end"
                    (click)="nestedProp[i.key]=!nestedProp[i.key]">â—¢</button>
                  }
                  <div>{{i.key}}</div>
                  <div class="text-muted small">{{i.value?.type}}</div>
                  @if(['object','array'].includes(i.value?.type)){
                  @if (nestedProp[i.key]){
                  <div class="small list-group mt-2">
                    @for(j of (extractJsonObj[i.key]?.properties||extractJsonObj[i.key]?.items?.properties)|keyvalue;
                    track $index){
                    <div class="list-group-item p-2">
                      <div>{{j.key}}</div>
                      <div class="text-muted small">{{j.value?.type}}</div>
                    </div>
                    }
                  </div>
                  }
                  }
                </div>
                }
              </div>
            </div>
            }
            @if(['imgcls'].includes(cogna.type) && imgclsCat.length>0){
            <div class="card overflow-hidden border border-2 mb-2">
              <div class="card-header p-2">
                <div class="text-muted text-strong col">SynSet ({{imgclsLen}} classes)</div>
              </div>
              <div class="list-group list-group-flush">
                @for(i of imgclsCat; track $index){
                <div class="list-group-item p-2 small">
                  {{i}}
                </div>
                }
                @if (imgclsMore>0){
                <div class="list-group-item p-1 bg-light small text-center fst-italic">
                  ...and {{imgclsMore}} more
                </div>
                }
              </div>
            </div>
            }



            @if (['txtcls'].includes(cogna.type) && cogna.data?.txtclsLlm){

            <div class="card overflow-hidden border border-2 mb-2">
              <div class="card-header p-2">
                <div class="text-muted text-strong col">
                  @if (classifyWhat){
                  {{classifyWhat}}
                  }@else {
                  Classifications
                  }
                </div>
              </div>

              @if (classifyLookupId){
              <div class="list-group list-group-flush">
                @for(le of lookupEntries;track $index){
                <div class="list-group-item p-2">
                  {{le.name}}
                </div>
                }@empty {
                <div class="text-black-50 p-3 text-center fs-4"> No lookup entries</div>
                }
              </div>
              }@else{
              <div class="text-black-50 p-3 text-center fs-4"> No lookup selected</div>
              }
            </div>
            }

            @if(['txtgen'].includes(cogna.type) || (['txtcls'].includes(cogna.type) && !cogna.data?.txtclsLlm)){
            <div class="card border border-2 mb-2" [class.border-success]="ingestSuccess[cogna.id]=='true'"
              [class.border-danger]="ingestSuccess[cogna.id]=='false'">
              <div class="card-header p-2">
                @if (cogna.sources?.length>0){
                <button type="button" class="btn btn-sm border border-2 btn-outline-secondary ms-auto float-end"
                  title="Ingest document sources" (click)="ingest(cogna)" [class.disabled]="ingestLoading()[cogna.id]">
                  @if (ingestLoading()[cogna.id]) {
                  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                  }@else {
                  <fa-icon [icon]="['fas','file-waveform']" [fixedWidth]="true"></fa-icon>
                  }
                  Ingest
                </button>
                }
                Sources
                <div class="small">{{cogna.sources.length}} documents</div>
              </div>
              <div class="list-group list-group-flush">
                @for (b of cogna.sources; track b.id) {
                <div class="list-group-item p-2 element">
                  <div class="element-edit nowrap" style="position:absolute;top:3px;right:3px; padding:3px">
                    @if(['dataset','bucket','url'].indexOf(b.type)>-1){
                    <a class="btn btn-round btn-sm btn-info"
                      href="{{baseApi}}/cogna/{{cogna?.id}}/ingested-file/{{b.id}}?r={{rand}}">
                      <fa-icon [icon]="['fas','download']" [fixedWidth]="true">
                      </fa-icon>
                    </a>
                    <button type="button" class="btn btn-round btn-sm btn-info" title="Edit Source"
                      (click)="editCognaSrc(editCognaSrcTpl, b, false)">
                      <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true">
                      </fa-icon>
                    </button>
                    }
                    <button type="button" class="btn btn-round btn-sm btn-info" title="Ingest Source"
                      (click)="ingestSrc(b)" [class.disabled]="ingestSrcLoading()[b.id]">
                      @if (ingestSrcLoading()[b.id]) {
                      <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                      }@else {
                      <fa-icon [icon]="['fas','file-waveform']" [fixedWidth]="true"></fa-icon>
                      }
                    </button>
                    <button type="button" class="btn btn-round btn-sm btn-danger" title="Clear DB Source"
                      (click)="clearDbSrc(b)" [class.disabled]="clearDbSrcLoading()[b.id]">
                      @if (clearDbSrcLoading()[b.id]) {
                      <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                      }@else {
                      <fa-icon [icon]="['fas','remove']" [fixedWidth]="true"></fa-icon>
                      }
                    </button>
                    <button type="button" class="btn btn-round btn-sm btn-danger" title="Remove Source"
                      (click)="removeCognaSrc(b)">
                      <fa-icon [icon]="['fas','trash']" [fixedWidth]="true">
                      </fa-icon>
                    </button>
                  </div>
                  <fa-icon class="float-start" [icon]="['fas',{'bucket':'box','dataset':'th','url':'globe'}[b.type]]"
                    [fixedWidth]="true"></fa-icon>
                  <div class=" ms-4">
                    @if (['bucket','dataset'].includes(b.type)){
                    {{b.name}}
                    <div class="small text-muted">{{b.type}}{{b.srcId?'_'+b.srcId:''}}</div>
                    }
                    @if (b.type=='url'){
                    {{b.srcUrl}}
                    <div class="small text-muted">Webpage</div>
                    }
                    @if (b.lastIngest){
                    <div class="text-muted small">{{b.lastIngest|date:'medium'}}</div>
                    }@else {
                    <div class="text-danger small">Not yet ingested</div>
                    }

                  </div>
                </div>
                @if(ingestRes()[b.id]){
                <div class="text-white p-1 small" [class.bg-success]="ingestRes()[b.id]?.success"
                  [class.bg-danger]="!ingestRes()[b.id]?.success">Doc: {{ingestRes()[b.id]?.docCount}}</div>
                }
                }@empty {
                <div class="text-black-50 p-3 text-center fs-4"> No sources specified</div>
                }
                <div class="list-group-item p-2">
                  <a class="pointer" (click)="editCognaSrc(editCognaSrcTpl,{appId:app.id},false)">
                    <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
                    Add Source
                  </a>
                </div>
                @if(ingestSuccess()[cogna.id]){
                <div class="list-group-item p-2 small text-white" [class.bg-success]="ingestSuccess()[cogna.id]=='true'"
                  [class.bg-danger]="ingestSuccess()[cogna.id]=='false'" [innerHTML]="ingestMessage()[cogna.id]">
                </div>
                }
              </div>
              <!-- <div class="card-body">
                    <a class="pointer" (click)="editCognaSrc(editCognaSrcTpl,{},false)">
                      <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
                      Add Source
                    </a>
                  </div> -->



            </div>

            <div class="card border border-2 mb-2">
              <div class="card-header p-2">
                Tools
                <div class="small">{{cogna.tools?.length}} tools</div>
              </div>
              <div class="list-group list-group-flush">
                @for (b of cogna.tools; track b.id) {
                <div class="list-group-item p-2 element">
                  <div class="element-edit nowrap" style="position:absolute;top:3px;right:3px; padding:3px">
                    <button type="button" class="btn btn-round btn-sm btn-info" title="Edit Tool"
                      (click)="editCognaTool(editCognaToolTpl, b, false)">
                      <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true">
                      </fa-icon>
                    </button>
                    <button type="button" class="btn btn-round btn-sm btn-danger" title="Remove Tool"
                      (click)="removeCognaTool(b)">
                      <fa-icon [icon]="['fas','trash']" [fixedWidth]="true">
                      </fa-icon>
                    </button>
                  </div>
                  <fa-icon class="float-start" [icon]="['fas','box']" [fixedWidth]="true"></fa-icon>
                  <div class="ms-4" [class.strike]="!b.enabled" [class.text-muted]="!b.enabled">{{b.name}}</div>
                </div>
                }@empty {
                <div class="text-black-50 p-3 text-center fs-4"> No tool specified</div>
                }
                <div class="list-group-item p-2">
                  <a class="pointer"
                    (click)="editCognaTool(editCognaToolTpl,{appId:app.id, enabled: true, params:[]},false)">
                    <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
                    Add Tool
                  </a>
                </div>
              </div>
            </div>

            <div class="card border border-2 mb-2">
              <div class="card-header p-2">
                Model Context Protocol (MCP)
                <div class="small">{{cogna.mcps?.length}} MCP Server</div>
              </div>
              <div class="list-group list-group-flush">
                @for (b of cogna.mcps; track b.id) {
                <div class="list-group-item p-2 element">
                  <div class="element-edit nowrap" style="position:absolute;top:3px;right:3px; padding:3px">
                    <button type="button" class="btn btn-round btn-sm btn-info" title="Edit Server"
                      (click)="editCognaMcp(editCognaMcpTpl, b, false)">
                      <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true">
                      </fa-icon>
                    </button>
                    <button type="button" class="btn btn-round btn-sm btn-danger" title="Remove Server"
                      (click)="removeCognaMcp(b)">
                      <fa-icon [icon]="['fas','trash']" [fixedWidth]="true">
                      </fa-icon>
                    </button>
                  </div>
                  <fa-icon class="float-start" [icon]="['fas','file']" [fixedWidth]="true"></fa-icon>
                  <div class="ms-4" [class.strike]="!b.enabled" [class.text-muted]="!b.enabled">{{b.name}}</div>
                </div>
                }@empty {
                <div class="text-black-50 p-3 text-center fs-4"> No MCP server specified</div>
                }
                <div class="list-group-item p-2">
                  <a class="pointer"
                    (click)="editCognaMcp(editCognaMcpTpl,{appId:app.id, enabled: true, timeout:60},false)">
                    <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
                    Add MCP server
                  </a>
                </div>
              </div>
            </div>

            <div class="card border border-2 mb-2">
              <div class="card-header p-2">
                <button type="button" class="btn btn-sm border border-2 btn-outline-secondary ms-auto float-end"
                  title="Clear vector collection" (click)="clearDb(cogna)" [class.disabled]="clearDbLoading">
                  @if (clearDbLoading) {
                  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                  }@else {
                  <fa-icon [icon]="['fas','trash']" [fixedWidth]="true"></fa-icon>
                  }
                  Clear
                </button>
                Vector Store/DB
              </div>
              <div class="card-body">
                <img [src]="dbMap[cogna.vectorStoreType]?.logo" height="18" />
                {{dbMap[cogna.vectorStoreType]?.name}}
                <!-- {{dbMap}} -->
                @if (cogna.vectorStoreType=='inmemory'){
                <div class="small text-danger mt-2">
                  Embedding will be stored in memory and will be lost on restart
                </div>
                }
              </div>
              <div class="card-body bg-light small p-2">
                Max Result: {{cogna.embedMaxResult}}, Min Score: {{cogna.embedMinScore??'None'}}
              </div>
            </div>
            }

            @if(['master'].includes(cogna.type)){
            <div class="card border border-2 mb-2">
              <div class="card-header p-2">
                Sub Agents
                <div class="small">{{cogna.subs?.length}} tools</div>
              </div>
              <div class="list-group list-group-flush">
                @for (b of cogna.subs; track b.id) {
                <div class="list-group-item p-2 element">
                  <div class="element-edit nowrap" style="position:absolute;top:3px;right:3px; padding:3px">
                    <button type="button" class="btn btn-round btn-sm btn-info" title="Edit Sub"
                      (click)="editCognaSub(editCognaSubTpl, b, false)">
                      <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true">
                      </fa-icon>
                    </button>
                    <button type="button" class="btn btn-round btn-sm btn-danger" title="Remove Sub"
                      (click)="removeCognaSub(b)">
                      <fa-icon [icon]="['fas','trash']" [fixedWidth]="true">
                      </fa-icon>
                    </button>
                  </div>
                  <fa-icon class="float-start" [icon]="['fas','box']" [fixedWidth]="true"></fa-icon>
                  <div class="ms-4" [class.strike]="!b.enabled" [class.text-muted]="!b.enabled">{{b.name}}</div>
                </div>
                }@empty {
                <div class="text-black-50 p-3 text-center fs-4"> No sub specified</div>
                }
                <div class="list-group-item p-2">
                  <a class="pointer" (click)="editCognaSub(editCognaSubTpl,{appId:app.id, enabled: true},false)">
                    <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
                    Add Sub
                  </a>
                </div>
              </div>
            </div>
            }
          </div>
          <div class="col-sm-8 col-lg-9">
            @if(['txtgen','master'].includes(cogna.type)){
            <div class="rounded rounded-2 bg-light border border-1 overflow-hidden shadow-sm">
              <div class="bg-secondary bg-opacity-25 d-flex flex-row p-1">
                <div class="p-3 py-1">
                  Preview: ({{embedModelTypeMap[cogna.inferModelType]?.name}} - {{cogna.inferModelName}})
                </div>
                <div ngbDropdown class="ms-auto d-inline-block">
                  <button type="button" class="btn btn-sm border border-2 btn-outline-danger ms-auto"
                    title="Clear chat memory" ngbDropdownToggle>
                    <fa-icon [icon]="['fas','trash']" [fixedWidth]="true"></fa-icon> Clear Memory
                  </button>
                  <div ngbDropdownMenu style="min-width:340px">
                    <button type="button" title="Clear memory for {{user.email}}" ngbDropdownItem
                      (click)="clearUserMemory(cogna)">
                      Clear memory for {{user.email}}
                    </button>
                    <div class="dropdown-divider"></div>
                    <button type="button" title="Clear memory for all user" ngbDropdownItem
                      (click)="clearMemory(cogna)">
                      Clear memory for all user
                    </button>
                  </div>
                </div>
              </div>
              <div id="chat-response-list" class="p-3 bg-white"
                style="min-height:300px; max-height:600px;overflow:auto">
                @for (p of chatResponseList; track $index) {
                @if(p.text){
                <div class="p-2 border-1 mb-3 rounded-2 shadow-sm cogna-resp {{p.type}}"
                  [innerHtml]="targetBlank(p.text)">
                </div>
                }
                @if (p.files?.length>0){
                <div class="mb-3">
                  @for(file of p.files; track $index){
                  @if (file.isImage){
                  <img [src]="baseApi+'/cogna/'+cogna.id+'/file/'+file.path" style="max-width:70%">
                  }@else {
                  <div><fa-icon [icon]="['far','file']"></fa-icon> {{file.path}} </div>
                  }
                  }
                </div>
                }
                }
                @if (chatPromptLoading()){
                <div class="text-center">
                  <div class="spinner-grow" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
                }
                @if (streamTyping()){

                <div class="p-2 border-1 mb-3 rounded-2 shadow-sm cogna-resp response" [innerHtml]="streamResult()">
                </div>
                }
              </div>
              <div>
                <div class="bg-light p-2">Custom Parameters</div>
                <app-cm name="cognaparam" lang="javascript" #codeeditorcognaparam [placeholder]="defaultCognaParam"
                  subType="active" [skipCheck]="true" [hideControl]="true" [extraAutoComplete]="extraAutoCompleteJs"
                  [(ngModel)]="chatPromptParam" [linenumber]="true" required>
                </app-cm>
              </div>

              <div class="bg-secondary bg-opacity-25">


                <div class="d-flex flex-row p-2">
                  @if (cogna.mmSupport){
                  <label class="rounded-pill me-2 cursor-pointer d-flex align-items-center justify-content-center"
                    style="width:48px; cursor: pointer;">
                    <input type="file" [hidden]="true" (change)="onUpload($event)" name="file" />
                    <!-- @if(fileList.length>0){ -->
                    <!-- @for(file of fileList; track $index){
                              <img [src]="baseApi+'/cogna/'+cogna.id+'/file/'+file" width="100%">
                            }  -->


                    <!-- }@else { -->
                    <fa-icon [icon]="['fas','upload']"></fa-icon>
                    <!-- } -->
                  </label>
                  }


                  <input type="text" id="chat-prompt-text" class="border-0 w-100 rounded-pill px-3 py-1"
                    autocomplete="off" (keyup.enter)="chatPrompt(cogna, chatPromptText())" autocapitalize="none"
                    [(ngModel)]="chatPromptText" maxlength="2000" placeholder="Ask me something...">
                  <button type="button" class="btn bg-transparent border-0" style="height:38px; min-width:38px"
                    [disabled]="!(chatPromptText()?.trim() || fileList.length>0)"
                    (click)="chatPrompt(cogna, chatPromptText())">
                    <fa-icon [icon]="['fas','paper-plane']"></fa-icon>
                  </button>
                </div>
                @if(fileList.length>0){
                <div class="small list-group list-group-flush mb-3">
                  @for(f of fileList; track $index){
                  @if (f.isImage){
                  <div class="list-group-item p-2"><button type="button" class="btn btn-xs btn-light float-end"
                      (click)="removeFile($index)">&times;</button>
                    <img [src]="baseApi+'/cogna/'+cogna.id+'/file/'+f.path" style="max-width:200px">
                  </div>
                  }@else {
                  <div class="list-group-item p-2"><button type="button" class="btn btn-xs btn-light float-end"
                      (click)="removeFile($index)">&times;</button> {{f.path}} </div>
                  }
                  }
                </div>
                }

                <div class="text-end text-muted px-3 py-1 small">
                  {{chatPromptText()?.length||0}}/2000
                </div>

              </div>
            </div>
            }
            @if(['txtext'].includes(cogna.type)){
            <div class="card">
              <div class="card-header">
                Testing/Preview
              </div>
              <div class="card-body" [class.disabled]="extractLoading()">
                <div class="form-group mb-3">
                  <label class="form-label">Extract from documents</label>
                  <label style="width:100%">
                    <input type="file" [hidden]="true" (change)="onUploadExtract($event)" name="file" />
                    <div class="form-control" style="background: white">
                      <fa-icon [icon]="['fas','upload']"></fa-icon>
                      Browse documents
                    </div>
                  </label>
                </div>
                @if(fileList.length>0){
                <div class="small list-group list-group-flushed mb-3">
                  @for(f of fileList; track $index){
                  <div class="list-group-item p-2"><button type="button" class="btn btn-xs btn-light float-end"
                      (click)="removeFile($index)">&times;</button> {{f}} </div>
                  }
                </div>
                }
                <div class="text-center my-2 mx-n3 bg-light p-2">or</div>
                <div class="form-group mb-3">
                  <label class="form-label">Extract from text</label>
                  <textarea class="form-control" [(ngModel)]="extractData.text" rows="4" name="extractText"
                    id="extractText" required></textarea>
                </div>
              </div>
              <div class="card-footer">
                <button type="button" (click)="startExtractData(cogna)"
                  [disabled]="extractLoading() || !(fileList.length>0||extractData.text)"
                  class="btn btn-primary btn-round px-3">
                  @if(extractLoading()){
                  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                  <span class="visually-hidden" role="status">Loading...</span>
                  }
                  Extract Data
                </button>
              </div>
            </div>

            <div class="card mt-2">
              <div class="card-header">Result</div>
              <div class="card-body">
                <div class="px-2 py-1 bg-white small limit-height">
                  @if (!isEmptyObject(extractRes()[cogna.id])) {
                  <json-viewer [json]="extractRes()[cogna.id]"></json-viewer>
                  <!-- <pre><code class="language-js">{{extractRes()[cogna.id] | json}}</code></pre> -->
                  }@else{
                  <div class="text-muted">No response</div>
                  }
                  @if(extractError()[cogna.id]){
                  <div class="bg-error p-2">{{extractError()[cogna.id]}}</div>
                  }
                </div>
              </div>
            </div>
            }
            @if(['imgcls'].includes(cogna.type)){
            <div class="card">
              <div class="card-header">
                Testing/Preview
              </div>
              <div class="card-body" [class.disabled]="imgclsLoading">
                <div class="form-group mb-3">
                  <label class="form-label">Classify image</label>
                  <label style="width:100%">
                    <input type="file" [hidden]="true" (change)="onUploadExtract($event)" name="file" />
                    <div class="form-control" style="background: white">
                      <fa-icon [icon]="['fas','upload']"></fa-icon>
                      Browse documents
                    </div>
                  </label>
                </div>
                @if(fileList.length>0){
                <div class="small list-group list-group-flushed mb-3">
                  @for(f of fileList; track $index){
                  <div class="list-group-item p-2"><button type="button" class="btn btn-xs btn-light float-end"
                      (click)="removeFile($index)">&times;</button>
                    <img [src]="baseApi+'/cogna/'+cogna.id+'/file/'+f" style="max-width:70%">
                  </div>
                  }
                </div>
                }
              </div>
              <div class="card-footer">
                <button type="button" (click)="startImgClsData(cogna)" [disabled]="imgclsLoading"
                  class="btn btn-primary btn-round px-3">
                  @if(imgclsLoading){
                  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                  <span class="visually-hidden" role="status">Loading...</span>
                  }
                  Classify Image
                </button>
              </div>
            </div>

            <div class="card mt-2">
              <div class="card-header">Result</div>
              <div class="card-body">
                <div class="px-2 py-1 bg-white small">
                  @if (!isEmptyObject(imgclsRes[cogna.id])) {
                  <!-- <pre><code class="language-js">{{imgclsRes | json}}</code></pre> -->
                  @for(img of imgclsRes[cogna.id]|keyvalue; track $index){
                  <div class="row g-1">
                    <div class="col-6">
                      @if (cogna.inferModelName.includes("yolo")){
                      <img [src]="baseApi+'/cogna/'+cogna.id+'/file/segmented-'+img.key" width="100%">
                      }@else {
                      <img [src]="baseApi+'/cogna/'+cogna.id+'/file/'+img.key" width="100%">
                      }
                    </div>
                    <div class="col-6">
                      <ul>
                        @for (pred of img.value; track $index){
                        <li>{{pred.desc}} (Score: {{pred.score}})</li>
                        }
                      </ul>
                    </div>
                  </div>



                  }


                  }@else{
                  <div class="text-muted">No response</div>
                  }
                  @if(imgclsError[cogna.id]){
                  <div class="bg-error p-2">{{imgclsError[cogna.id]}}</div>
                  }
                </div>
              </div>
            </div>
            }
            @if(['txtcls'].includes(cogna.type)){
            <div class="card">
              <div class="card-header">
                Testing/Preview
              </div>
              <div class="card-body" [class.disabled]="classifyLoading">


                @if (cogna.data?.txtclsLlm){
                <div class="input-group input-group-sm mt-1 mb-2">
                  <label class="input-group-text">Classification of what *</label>
                  <input type="text" class="form-control" [(ngModel)]="classifyWhat" name="classifyWhat"
                    placeholder="ie: Sentiment" required>
                </div>
                <div class="input-group input-group-sm mt-1 mb-2">
                  <label class="input-group-text">Classification Lookup *</label>
                  <select class="form-select" name="classifyLookupId" (ngModelChange)="loadLookupEntries($event)"
                    [(ngModel)]="classifyLookupId" required>
                    <option value="" disabled>Select lookup...</option>
                    @for (lookup of lookupList; track $index) {
                    <option [ngValue]="lookup.id">{{lookup.name}}
                      [{{lookup.id}}]
                    </option>
                    }
                  </select>
                </div>
                }@else {
                <div class="input-group input-group-sm mt-1 mb-2">
                  <label class="input-group-text">Min Score *</label>
                  <input type="text" class="form-control" [(ngModel)]="classifyMinScore" name="classifyMinScore"
                    (change)="startClassifyData(cogna)" placeholder="ie: 0.8" required>
                </div>
                }

                <div class="form-group mb-3">
                  <div class="form-check form-switch">
                    <input type="checkbox" class="form-check-input" id="classifyMultiple"
                      (change)="startClassifyData(cogna)" [(ngModel)]="classifyMultiple" name="classifyMultiple">
                    <label class="form-check-label" for="classifyMultiple">Classify into multiple results</label>
                  </div>
                </div>

                <div class="form-group mb-3">
                  <label class="form-label">Classify from text</label>
                  <textarea class="form-control" [(ngModel)]="classifyText" rows="4" name="classifyText"
                    id="classifyText" required></textarea>
                </div>
              </div>
              <div class="card-footer">
                <button type="button" (click)="startClassifyData(cogna)"
                  [disabled]="classifyLoading || (cogna.data?.txtclsLlm && (!classifyWhat || !classifyLookupId))"
                  class="btn btn-primary btn-round px-3">
                  @if(classifyLoading){
                  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                  <span class="visually-hidden" role="status">Loading...</span>
                  }
                  Classify Data</button>
              </div>
            </div>
            <div class="card mt-2">
              <div class="card-header">Result</div>
              <div class="card-body">
                <div class="px-2 py-1 bg-white small limit-height">
                  @if (classifyIsOk){
                  @if (!isEmptyObject(classifyRes[cogna.id])) {

                  @if (classifyMultiple){

                  @for(cat of classifyRes[cogna.id]?.category; track $index; let last = $last){
                  <div>Category: <strong>{{classifyRes[cogna.id]?.category[$index]}}</strong></div>
                  @if (classifyRes[cogna.id]?.data){
                  <div>Data:</div>
                  <pre><code class="language-js">{{classifyRes[cogna.id]?.data[$index] | json}}</code></pre>
                  }
                  @if (classifyRes[cogna.id]?.score){
                  <div>Score: {{classifyRes[cogna.id]?.score[$index]}}</div>
                  }
                  @if (!$last){
                  <hr>
                  }
                  }

                  }@else{
                  <div>Category: <strong>{{classifyRes[cogna.id]?.category}}</strong></div>
                  @if (classifyRes[cogna.id]?.score){
                  <div>Score: {{classifyRes[cogna.id]?.score}}</div>
                  }
                  @if (classifyRes[cogna.id]?.data){
                  <div>Data:</div>
                  <pre><code class="language-js">{{classifyRes[cogna.id]?.data | json}}</code></pre>
                  }

                  }

                  }@else{
                  <div class="text-muted">No response</div>
                  }
                  }@else{
                  <div class="text-danger">{{classifyError[cogna.id]}}</div>
                  }

                </div>
              </div>
            </div>
            }
            @if(['imggen'].includes(cogna.type)){
            <div class="card">
              <div class="card-header">
                Testing/Preview
              </div>
              <div class="card-body" [class.disabled]="imgGenLoading">
                <div class="form-group">
                  <label class="form-label">Generate from text</label>
                  <textarea class="form-control" [(ngModel)]="imgGenText" rows="4" name="imgGenText" id="imgGenText"
                    required></textarea>
                </div>
              </div>
              <div class="card-footer">
                <button type="button" (click)="startGenerateImg(cogna)" [disabled]="imgGenLoading"
                  class="btn btn-primary btn-round px-3">
                  @if(imgGenLoading){
                  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                  <span class="visually-hidden" role="status">Loading...</span>
                  }
                  Generate Image</button>
              </div>
            </div>


            <div class="card mt-2">
              <div class="card-header">Result</div>
              <div class="card-body">
                <div class="px-2 py-1 bg-white small">
                  @if (!isEmptyObject(imgGenRes[cogna.id])) {
                  Generated Image URL:
                  <div class="mb-3"><a [href]="imgGenRes[cogna.id]?.url"
                      target="_blank">{{imgGenRes[cogna.id]?.url}}</a></div>
                  <img [src]="imgGenRes[cogna.id]?.url" width="100%">
                  <!-- <div>Category: {{imgGenRes.category}}</div>
                      <div>Score: {{imgGenRes.score}}</div> -->
                  }@else{
                  <div class="text-muted">No response</div>
                  }
                  @if(imgGenError[cogna.id]){
                  <div class="bg-error p-2">{{imgGenError[cogna.id]}}</div>
                  }

                </div>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
      }@else{
      <div style="color:#aaa;">
        <h3>Please select Cogna from the list on the left to view it's data.</h3>
      </div>
      }
    </div>
  </div>
</div>

<ng-template #removeCognaTpl let-c="close" let-d="dismiss">
  <div>
    <div class="modal-header">
      <h4 class="modal-title">Remove Cogna</h4>
    </div>
    <div class="modal-body">
      <div class="form form-horizontal">
        <div class="form-group mb-3">
          <label class="form-label">Cogna Name</label>
          <p class="form-control-static">{{removeCognaData.name}}</p>
        </div>
        <div class="form-group mb-3">
          <label class="form-label">Description</label>
          <p class="form-control-static">{{removeCognaData.name}}</p>
        </div>
      </div>
    </div>
    <div class="modal-footer justify-content-between">
      <button type="button" class="btn btn-round" (click)="d()">Close</button>
      <button type="button" class="btn btn-round btn-primary" (click)="c(removeCognaData)">
        <i class="icon-minus-sign-alt"></i> Remove Cogna
      </button>
    </div>
  </div>
</ng-template>


<ng-template #editCognaTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">{{editCognaData.id?'Edit':'Add'}} Cogna</h4>
  </div>
  <div ngbAccordion #cognaEditForm="ngForm" ngForm class="accordion-flush fix-gutter" [closeOthers]="true"
    [destroyOnHide]="false">
    <div ngbAccordionItem [collapsed]="false">
      <h2 ngbAccordionHeader>
        <button type="button" class="p-3" ngbAccordionButton>
          <div class="accordion-index">1</div>
          <div>Basic Information
            <div class="small fst-italic">Provide basic cogna information</div>
          </div>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody class="p-3">
          <ng-template>
            <div class="form-group mb-3">
              <label class="form-label">Cogna Name *</label>
              <input type="text" class="form-control" [(ngModel)]="editCognaData.name" #name="ngModel"
                (change)="editCognaData.id||editCognaData.code=toHyphen(editCognaData.name)" name="name" required>
              @if (name?.invalid) {
              <small class="form-text has-warning">
                @if (name?.errors?.required) {
                <span class="help-block">Name is required</span>
                }
              </small>
              }
            </div>
            <div class="form-group mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" [(ngModel)]="editCognaData.description" name="description"></textarea>
            </div>
            <div class="form-group mb-3">
              <label class="form-label">Used to *</label>
              <div>
                <div name="lang" class="text-dark">
                  <!-- ggml-gpt4all-j-v1.3-groovy.bin -->
                  <input type="radio" class="btn-check" id="txtgen" name="txtgen" value="txtgen" #cognaType="ngModel"
                    [(ngModel)]="editCognaData.type" [required]="true">
                  <label for="txtgen" class="btn btn-outline-secondary border-2 me-1 mb-1">
                    Generate<br />Text
                  </label>
                  <input type="radio" class="btn-check" id="txtcls" name="txtcls" value="txtcls"
                    (click)="editCognaData.vectorStoreType='chromadb'" #cognaType="ngModel"
                    [(ngModel)]="editCognaData.type" [required]="true">
                  <label for="txtcls" class="btn btn-outline-secondary border-2 me-1 mb-1">
                    Classify<br />Text
                  </label>
                  <input type="radio" class="btn-check" id="txtext" name="txtext" value="txtext" #cognaType="ngModel"
                    [(ngModel)]="editCognaData.type" [required]="true">
                  <label for="txtext" class="btn btn-outline-secondary border-2 me-1 mb-1">
                    Extract<br />Data
                  </label>
                  <input type="radio" class="btn-check" id="imggen" name="imggen" value="imggen" #cognaType="ngModel"
                    [(ngModel)]="editCognaData.type" [required]="true">
                  <label for="imggen" class="btn btn-outline-secondary border-2 me-1 mb-1" (click)="setImgGenModels()">
                    Generate<br />Image
                  </label>
                  <input type="radio" class="btn-check" id="imgcls" name="imgcls" value="imgcls" #cognaType="ngModel"
                    [(ngModel)]="editCognaData.type" [required]="true">
                  <label for="imgcls" class="btn btn-outline-secondary border-2 me-1 mb-1" (click)="setImgClsModels()">
                    Classify<br />Image
                  </label>
                  <input type="radio" class="btn-check" id="master" name="master" value="master" #cognaType="ngModel"
                    [(ngModel)]="editCognaData.type" [required]="true">
                  <label for="master" class="btn btn-outline-secondary border-2 me-1 mb-1">
                    Master<br />Agent
                  </label>
                </div>
              </div>
              @if (cognaType?.invalid) {
              <small class="form-text has-warning">
                @if (cognaType?.errors?.required) {
                <span class="help-block">Cogna type is required</span>
                }
              </small>
              }
            </div>

            @if (['imggen'].includes(editCognaData.type)){
            <div class="form-group">
              <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="genBucket"
                  [(ngModel)]="editCognaData.data.genBucket" name="genBucket">
                <label class="form-check-label" for="genBucket">Store generated image to Bucket</label>
                @if (editCognaData.data.genBucket){
                <div class="input-group input-group-sm mt-1 mb-2">
                  <label class="input-group-text">Select Bucket *</label>
                  <select class="form-select" name="genBucketId" [(ngModel)]="editCognaData.data.genBucketId" required>
                    <option value="" disabled>Select bucket...</option>
                    @for (bucket of bucketList; track $index) {
                    <option [ngValue]="bucket.id">{{bucket.name}}
                      [{{bucket.id}}]
                    </option>
                    }
                  </select>
                </div>
                }
              </div>
            </div>
            }

            <div class="form-group">
              <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="publicAccess"
                  [(ngModel)]="editCognaData.publicAccess" name="publicAccess">
                <label class="form-check-label" for="publicAccess">Public Cogna (require no authentication)</label>
              </div>
            </div>
            @if (['txtcls'].includes(editCognaData.type)){
            <div class="form-group">
              <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="txtclsLlm"
                  [(ngModel)]="editCognaData.data.txtclsLlm" name="txtclsLlm">
                <label class="form-check-label" for="txtclsLlm">Use LLM for text classification
                </label>
              </div>
            </div>
            }
            <div class="form-group mt-3 mb-3">
              <label class="form-label">Cogna Path</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text">{{base}}/~cogna/</span>
                <input type="text" class="form-control" [(ngModel)]="editCognaData.code"
                  [ngModelOptions]="{updateOn: 'blur'}" #code="ngModel" name="code" [uniqueAppPath]="initialCode"
                  [uniqueAppPathFn]="isCodeTaken">
                <span class="input-group-text">/{{cognaEp[editCognaData.type]}}</span>
              </div>
              @if (code.pending) {
              <small>Checking availability...</small>
              }
              @if (code.invalid) {
              <small class="text-danger">
                @if (code.errors?.uniqueAppPath) {
                <span>
                  Cogna path <strong>{{editCognaData.code}}</strong> is already taken.
                </span>
                }
              </small>
              }
              @if (code.valid && editCognaData.code && initialCode!=editCognaData.code) {
              <small class="text-success">
                Cogna path <strong>{{editCognaData.code}}</strong> is available.
              </small>
              }
            </div>
            <div class="form-group mb-3">
              <label class="form-label">Creator (email, comma separated)</label>
              <input type="text" class="form-control" [(ngModel)]="editCognaData.email" name="email" #email="ngModel"
                required>
              @if (email?.invalid) {
              <small class="form-text has-warning">
                @if (email?.errors?.required) {
                <span class="help-block">Creator email is required</span>
                }
              </small>
              }
            </div>
          </ng-template>
        </div>
      </div>
    </div>
    <!-- Embedding only required for textgeneration and classification -->
    @if(['txtgen'].includes(editCognaData.type) || (['txtcls'].includes(editCognaData.type) && !editCognaData.data?.txtclsLlm)){
    <div ngbAccordionItem>
      <h2 ngbAccordionHeader>
        <button type="button" class="p-3" ngbAccordionButton>
          <div class="accordion-index">2</div>
          <div>Embedding
            <div class="small fst-italic">Setup model to vectorize your data</div>
          </div>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody class="p-3">
          <ng-template>
            <div class="row">
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label" for="binds">Model Type *</label>
                  <select class="form-select" name="embedModelType" [(ngModel)]="editCognaData.embedModelType"
                    #embedModelType="ngModel" required>
                    @for (item of embedModelTypeList; track $index) {
                    <option [value]="item.code">{{item.name}}
                    </option>
                    }
                  </select>
                </div>
              </div>
              @if(!['minilm','e5small','e5large'].includes(editCognaData.embedModelType)){
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label" for="binds">Model Name *</label>
                  @if(editCognaData.data.overrideEmbed){
                  <input type="text" class="form-control" [(ngModel)]="editCognaData.embedModelName"
                    #embedModelName="ngModel" name="embedModelName" required>
                  }@else{
                  <select class="form-select" name="embedModelName" [(ngModel)]="editCognaData.embedModelName"
                    #embedModelName="ngModel" required>
                    @for (item of embedModelNameList|filter:editCognaData.embedModelType; track $index) {
                    <option [value]="item.code">{{item.name}}
                    </option>
                    }
                  </select>
                  }
                </div>
              </div>
              }

            </div>
            @if(!['minilm','e5small','e5large'].includes(editCognaData.embedModelType)){
            <div class="form-check form-switch mb-3">
              <input type="checkbox" class="form-check-input" id="overrideEmbed"
                [(ngModel)]="editCognaData.data.overrideEmbed" name="overrideEmbed">
              <label class="form-check-label" for="overrideEmbed">Override Embedding Configuration</label>
            </div>
            @if (editCognaData.embedModelType=='vertex-ai'){
            <div class="row">
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label">Project ID</label>
                  <input type="text" class="form-control form-control-sm" [(ngModel)]="editCognaData.data.embedProject"
                    #embedModelProject="ngModel" name="embedModelProject" required>
                </div>
              </div>
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label">Location</label>
                  <input type="text" class="form-control form-control-sm" [(ngModel)]="editCognaData.data.embedLocation"
                    #embedModelLocation="ngModel" name="embedModelLocation" required>
                </div>
              </div>
            </div>
            } @else if (['localai','ollama'].includes(editCognaData.embedModelType)){
            <div class="row">
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label">Base URL</label>
                  <input type="text" class="form-control form-control-sm" [(ngModel)]="editCognaData.data.embedBaseUrl"
                    #embedBaseUrl="ngModel" name="embedBaseUrl" required>
                </div>
              </div>
              <!-- <div class="col-6">
                      <div class="form-group mb-3">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control form-control-sm" [(ngModel)]="editCognaData.data && editCognaData.data.inferLocation" #inferModelLocation="ngModel" name="inferModelLocation"
                          required>
                      </div>
                    </div> -->
            </div>
            }@else {
            <div class="form-group mb-3">
              <label class="form-label">Model API Key/Access Token <fa-icon [icon]="['fas','key']" [fixedWidth]="true" title="Support Secret placeholder"></fa-icon></label>
              <input type="text" class="form-control form-control-sm" [(ngModel)]="editCognaData.embedModelApiKey"
                list="embedSecretList"
                #embedModelApiKey="ngModel" autocomplete="off" name="embedModelApiKey" required>

                <datalist id="embedSecretList">
                  @for(secret of secretList; track $index) {
                    @let secretKey = '{{_secret.'+secret.key+'}}';
                    <option value="{{secretKey}}">Secret: {{secret.key}}</option>
                  }
                </datalist>
            </div>
            }
            }


            <div class="row">
              <div class="col">
                <div class="form-group mb-3">
                  <label class="form-label">Chunk Length *</label>
                  <input type="number" class="form-control" [(ngModel)]="editCognaData.chunkLength"
                    #chunkLength="ngModel" name="chunkLength" required>
                </div>
              </div>
              <div class="col">
                <div class="form-group mb-3">
                  <label class="form-label">Chunk Overlap *</label>
                  <input type="number" class="form-control" [(ngModel)]="editCognaData.chunkOverlap"
                    #chunkOverlap="ngModel" name="chunkOverlap" required>
                </div>
              </div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
    }
    @if(['txtgen','txtext','imggen', 'imgcls'].includes(editCognaData.type) || (['txtcls'].includes(editCognaData.type)
    && editCognaData.data?.txtclsLlm)){
    <div ngbAccordionItem>
      <h2 ngbAccordionHeader>
        <button type="button" class="p-3" ngbAccordionButton>
          <div class="accordion-index">3</div>
          <div>Inference
            <div class="small fst-italic">Setup model to generate output</div>
          </div>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody class="p-3">
          <ng-template>
            @if(['txtgen','txtext','imggen','txtcls','imgcls'].includes(editCognaData.type)){
            <div class="row">
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label" for="binds">Model Type *</label>
                  <select class="form-select" name="inferModelType" [(ngModel)]="editCognaData.inferModelType"
                    [disabled]="editCognaData.type=='imgcls'" #inferModelType="ngModel" required>
                    @for (item of inferModelTypeList|filter:editCognaData.type; track $index) {
                    <option [value]="item.code">{{item.name}}
                    </option>
                    }
                  </select>
                </div>
              </div>
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label" for="binds">Model Name *</label>
                  @if(editCognaData.data.overrideInfer){
                  <input type="text" class="form-control" [(ngModel)]="editCognaData.inferModelName"
                    #inferModelName="ngModel" name="inferModelName" required>
                  }@else{
                  <select class="form-select" name="inferModelName" [(ngModel)]="editCognaData.inferModelName"
                    #inferModelName="ngModel" required>
                    @for (item of (inferModelNameList|filter:editCognaData.inferModelType)|filter:editCognaData.type;
                    track $index) {
                    <option [value]="item.code">{{item.name}}
                    </option>
                    }
                  </select>
                  }
                </div>
              </div>

            </div>
            <div class="form-check form-switch">
              <input type="checkbox" class="form-check-input" id="overrideInfer"
                [(ngModel)]="editCognaData.data.overrideInfer" name="overrideInfer">
              <label class="form-check-label" for="overrideInfer">Override Model Configuration</label>
            </div>
            <!-- @if(['txtgen','txtext'].includes(editCognaData.type)){
                 } -->

            @if(['imgcls'].includes(editCognaData.type)){
            <div class="form-group mt-3">
              <label class="form-label">List of classes (comma-separated) *</label>
              <textarea class="form-control" [(ngModel)]="editCognaData.data.imgclsCat"
                placeholder="List of classes (each class on new line)" rows="7" #imgclsCat="ngModel" name="imgclsCat"
                required></textarea>
            </div>

            <div class="row mt-3">
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label">Limit Result</label>
                  <input type="text" class="form-control" [(ngModel)]="editCognaData.data.imgclsLimit"
                    #imgclsLimit="ngModel" name="imgclsLimit" required>
                </div>
              </div>
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label">Min Score *</label>
                  <input type="number" class="form-control" [(ngModel)]="editCognaData.data.imgclsMinScore"
                    #imgclsMinScore="ngModel" name="imgclsMinScore" required>
                </div>
              </div>
            </div>

            <div class="form-check form-switch">
              <input type="checkbox" class="form-check-input" id="showScore"
                [(ngModel)]="editCognaData.data.imgclsShowScore" name="showScore">
              <label class="form-check-label" for="showScore">Include score in the result</label>
            </div>
            }

            @if (['txtgen', 'txtcls'].includes(editCognaData.type)){
            <div class="mb-3">
              <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="mmSupport" [(ngModel)]="editCognaData.mmSupport"
                  name="mmSupport">
                <label class="form-check-label" for="mmSupport">Enable multimodal support (only for selected
                  model)</label>
              </div>
            </div>
            <h5>Pre-processing</h5>
            <div class="form-check form-switch">
              <input type="checkbox" class="form-check-input" id="txtextractOn"
                [(ngModel)]="editCognaData.data.txtextractOn" name="txtextractOn">
              <label class="form-check-label" for="txtextractOn">Extract text from the file input</label>
            </div>

            <div class="form-check form-switch">
              <input type="checkbox" class="form-check-input" id="imgclsOn" [(ngModel)]="editCognaData.data.imgclsOn"
                name="imgclsOn">
              <label class="form-check-label" for="imgclsOn">Classify image from the file input</label>
              @if(editCognaData.data.imgclsOn){
              <div class="input-group input-group-sm mt-1 mb-2">
                <label class="input-group-text" for="imgclsCogna">Select cogna</label>
                <select class="form-select" name="imgclsCogna" [(ngModel)]="editCognaData.data.imgclsCogna" required>
                  @for (cogna of cognaList; track $index) {
                  <option [value]="cogna.id">{{cogna.name}}</option>
                  }
                </select>
              </div>
              }
            </div>
            <div class="form-check form-switch mb-3">
              <input type="checkbox" class="form-check-input" id="txtclsOn" [(ngModel)]="editCognaData.data.txtclsOn"
                name="txtclsOn">
              <label class="form-check-label" for="txtclsOn">Classify text and load lookup data</label>
              @if(editCognaData.data.txtclsOn){
              <div class="input-group input-group-sm mt-1 mb-2">
                <label class="input-group-text" for="txtclsCogna">Select cogna</label>
                <select class="form-select" name="imgclsCogna" [(ngModel)]="editCognaData.data.txtclsCogna" required>
                  @for (cogna of cognaList; track $index) {
                  <option [value]="cogna.id">{{cogna.name}}</option>
                  }
                </select>
              </div>
              }
            </div>
          }
          @if (['txtgen'].includes(editCognaData.type)){
            <h5>Post-processing</h5>
            <div class="form-check form-switch">
              <input type="checkbox" class="form-check-input" id="imggenOn" [(ngModel)]="editCognaData.data.imggenOn"
                name="imggenOn">
              <label class="form-check-label" for="imggenOn">Enable image generator when suitable</label>
              @if(editCognaData.data.imggenOn){
              <div class="input-group input-group-sm mt-1 mb-2">
                <label class="input-group-text" for="imggenModel">Select cogna</label>
                <select class="form-select" name="imggenModel" [(ngModel)]="editCognaData.data.imggenCogna" required>
                  @for (cogna of cognaList; track $index) {
                  <option [value]="cogna.id">{{cogna.name}}</option>
                  }
                </select>
              </div>
              }
            </div>

            <div class="form-check form-switch mb-3">
              <input type="checkbox" class="form-check-input" id="jsonOutput"
                [(ngModel)]="editCognaData.data.jsonOutput" name="jsonOutput">
              <label class="form-check-label" for="jsonOutput">Output response as JSON</label>
            </div>
            <!-- <div class="form-check form-switch mb-3">
                    <input type="checkbox" class="form-check-input" id="txtextOn"
                      [(ngModel)]="editCognaData.data.txtextOn" name="txtextOn">
                    <label class="form-check-label" for="txtextOn">Response in json format</label>
                  </div> -->
            }

            @if(['imggen'].includes(editCognaData.type)){
            <div class="row mt-3">
              <div class="col-12">
                <div class="form-group mb-3">
                  <label class="form-label" for="imgSize">Output Size *</label>
                  <select class="form-select" name="imgSize" [(ngModel)]="editCognaData.data.imgSize" required>
                    @for (size of imgOutputSize[editCognaData.inferModelName]; track $index) {
                    <option [value]="size">{{size}}
                    </option>
                    }
                  </select>
                </div>
              </div>
              <!-- <div class="col-6">
                      <div class="form-group mb-3">
                        <label class="form-label">Quality *</label>
                        <div>
                          <div class="">
                            <input class="btn-check" type="radio" value="standard" id="imggen-quality-standard"
                              name="imggen-quality-standard" [(ngModel)]="editCognaData.data.imgQuality"
                              required>
                            <label for="imggen-quality-standard" class="btn btn-outline-secondary me-1 mb-1">
                            Standard</label>
                            <input class="btn-check" type="radio" value="hd" id="imggen-quality-hd"
                              name="imggen-quality-hd" [(ngModel)]="editCognaData.data.imgQuality" required>
                            <label for="imggen-quality-hd" [disabled]="editCognaData.inferModelName=='dall-e-3'" class="btn btn-outline-secondary me-1 mb-1">
                            HD</label>                            
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="form-group mb-3">
                        <label class="form-label">Style *</label>
                        <div>
                          <div class="">
                            <input class="btn-check" type="radio" value="vivid" id="imggen-style-vivid"
                              name="imggen-style-vivid" [(ngModel)]="editCognaData.data.imgStyle"
                              required>
                            <label for="imggen-style-vivid" class="btn btn-outline-secondary me-1 mb-1">
                            Vivid</label>
                            <input class="btn-check" type="radio" value="natural" id="imggen-style-natural"
                              name="imggen-style-natural" [(ngModel)]="editCognaData.data.imgStyle" required>
                            <label for="imggen-style-natural" class="btn btn-outline-secondary me-1 mb-1">
                            Natural</label>                            
                          </div>
                        </div>
                      </div>
                    </div> -->
            </div>
            }
            }

            @if (['txtgen','txtext','txtcls','imggen'].includes(editCognaData.type)){

            @if (editCognaData.inferModelType=='vertex-ai-gemini'){
            <div class="row">
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label">Project ID</label>
                  <input type="text" class="form-control form-control-sm" [(ngModel)]="editCognaData.data.inferProject"
                    #inferModelProject="ngModel" name="inferModelProject" required>
                </div>
              </div>
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label">Location</label>
                  <input type="text" class="form-control form-control-sm" [(ngModel)]="editCognaData.data.inferLocation"
                    #inferModelLocation="ngModel" name="inferModelLocation" required>
                </div>
              </div>
            </div>
            } @else if (['localai','ollama'].includes(editCognaData.inferModelType)){
            <div class="row">
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label">Base URL</label>
                  <input type="text" class="form-control form-control-sm" [(ngModel)]="editCognaData.data.inferBaseUrl"
                    #inferBaseUrl="ngModel" name="inferBaseUrl" required>
                </div>
              </div>
              <!-- <div class="col-6">
                      <div class="form-group mb-3">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control form-control-sm" [(ngModel)]="editCognaData.data && editCognaData.data.inferLocation" #inferModelLocation="ngModel" name="inferModelLocation"
                          required>
                      </div>
                    </div> -->
            </div>
            } @else {
            <div class="form-group mb-3">
              <label class="form-label">Model API Key/Access Token * <fa-icon [icon]="['fas','key']" [fixedWidth]="true" title="Support Secret placeholder"></fa-icon></label>
              <input type="text" class="form-control form-control-sm"
                [ngModel]="editCognaData && editCognaData.inferModelApiKey"
                (ngModelChange)="editCognaData && (editCognaData.inferModelApiKey = $event)" #inferModelApiKey="ngModel"
                list="inferSecretList" autocomplete="off" 
                name="inferModelApiKey" required>

                <datalist id="inferSecretList">
                  @for(secret of secretList; track $index) {
                    @let secretKey = '{{_secret.'+secret.key+'}}';
                    <option value="{{secretKey}}">Secret: {{secret.key}}</option>
                  }
                </datalist>
            </div>
            }
            }
            @if (editCognaData.type=='txtext' || (editCognaData.type=='txtgen' && editCognaData.data?.jsonOutput)){

            <div class="form-group mb-3">
              <label class="form-label">Format output using available form</label>
              <select class="form-select mb-3" name="form" #cForm
                (change)="loadFormatter(editCognaData.data.extractFormId, editHolderForm)"
                [ngModel]="editCognaData.data && editCognaData.data.extractFormId"
                (ngModelChange)="editCognaData.data && (editCognaData.data.extractFormId = $event)">
                <option [ngValue]="null">No specific form (create my own)</option>
                @for (form of formList; track form.id) {
                <option [ngValue]="form.id">{{form.title}}</option>
                }
              </select>
            </div>

            <!-- <select class="form-select" name="inferModelName" [(ngModel)]="editCognaData.data && editCognaData.data.extractFormId"
                    #inferModelName="ngModel" required>
                  @for (item of inferModelNameList|filter:editCognaData.inferModelType; track item) {
                    <option [value]="item.code">{{item.name}}
                    </option>
                  }
                </select> -->

            <!-- <div class="form-group mb-3">
                  <label class="form-label">JSON Formatting (comma-separated) *</label>
                  <textarea class="form-control" [(ngModel)]="editCognaData.data && editCognaData.data.extractFmt"
                  placeholder="// create JSON format {}"
                  rows="7"
                  #extractFmt="ngModel" name="extractFmt" required></textarea>
                </div> -->


            <!-- <div class="mx-n2">
                  <label class="form-label">JSON Formatting (comma-separated) *</label>
                  <app-cm content="content" lang="javascript" #extractFmt="ngModel"
                    name="extractFmt" subType="mailer" [(ngModel)]="editCognaData.data && editCognaData.data.extractFmt"
                    [linenumber]="true" required>
                  </app-cm>
                </div> -->
            <div class="form-group mb-3">
              <label class="form-label">JSON Formatting (JSON Schema Properties) *</label>
              <div class="mx-n2">
                <app-cm name="extractSchema" lang="javascript"
                  [ngModel]="editCognaData.data && editCognaData.data.extractSchema"
                  (ngModelChange)="editCognaData.data && (editCognaData.data.extractSchema = $event)"
                  [linenumber]="true" [skipCheck]="true" required></app-cm>
              </div>
              <a href="https://json-schema.org/" target="_blank">Learn more about JSON Schema</a>
            </div>
            <!-- <div class="form-group mb-3">
                  <label class="form-label">Fields to extract (comma-separated) *</label>
                  <textarea class="form-control" [(ngModel)]="editCognaData.data && editCognaData.data.extractField"
                  rows="5"
                  #extractField="ngModel" name="extractField" required></textarea>
                </div> -->
            }
            @if (editCognaData.type=='txtgen'){
            <div class="row">
              <div class="col-sm-6">
                <div class="form-group mb-3">
                  <label class="form-label">Creativity (temperature) * - {{editCognaData.temperature}}</label>
                  <input type="range" class="form-range" [ngModel]="editCognaData && editCognaData.temperature"
                    (ngModelChange)="editCognaData && (editCognaData.temperature = $event)" min="0" step="0.1" max="2.0"
                    #temperature="ngModel" name="temperature" required>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="form-group mb-3">
                  <label class="form-label">Chat Memory * - {{editCognaData.maxChatMemory}}</label>
                  <input type="range" class="form-range" [ngModel]="editCognaData && editCognaData.maxChatMemory"
                    (ngModelChange)="editCognaData && (editCognaData.maxChatMemory = $event)" min="1" max="20"
                    #maxChatMemory="ngModel" name="chatMemory" required>
                </div>
              </div>
              <!-- <div class="col-sm-3">
                    <div class="form-group mb-3">
                      <label class="form-label">Max Token * - {{editCognaData.maxChatMemory}}</label>
                      <input type="number" class="form-control" [(ngModel)]="editCognaData && editCognaData.maxToken" min="0" max="20" #maxToken="ngModel" name="maxToken"
                        required>
                    </div>
                  </div> -->
            </div>

            <div class="form-group mb-3">
              <label class="form-label">System Message</label>
              <textarea class="form-control" [ngModel]="editCognaData && editCognaData.systemMessage"
                (ngModelChange)="editCognaData && (editCognaData.systemMessage = $event)" name="systemMessage"
                rows="4"></textarea>
            </div>
            <div class="form-group mb-3">
              <label class="form-label">Post Message</label>
              <textarea class="form-control" [ngModel]="editCognaData && editCognaData.postMessage"
                (ngModelChange)="editCognaData && (editCognaData.postMessage = $event)" name="postMessage"
                rows="4"></textarea>
            </div>
            }
          </ng-template>
        </div>
      </div>
    </div>
    }
    @if(['txtgen'].includes(editCognaData.type)){
    <div ngbAccordionItem>
      <h2 ngbAccordionHeader>
        <button type="button" class="p-3" ngbAccordionButton>
          <div class="accordion-index">4</div>
          <div>Retrieval Augmentation (Optional)
            <div class="small fst-italic">Setup advanced retrieval augmented generation</div>
          </div>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody class="p-3">
          <ng-template>
            <div class="form-group mb-3">
              <label class="form-label">Retriever Augmentation *</label>
              <div>
                <div name="lang" class="text-dark">
                  <input type="radio" class="btn-check" id="naive" name="naive" [value]="undefined" #augmentor="ngModel"
                    [ngModel]="editCognaData && editCognaData.augmentor"
                    (ngModelChange)="editCognaData && (editCognaData.augmentor = $event)">
                  <label for="naive" class="btn btn-outline-secondary border-2 me-2">
                    Naive<br />(Default)
                  </label>
                  <input type="radio" class="btn-check" id="compressor" name="compressor" value="compressor"
                    #augmentor="ngModel" [ngModel]="editCognaData && editCognaData.augmentor"
                    (ngModelChange)="editCognaData && (editCognaData.augmentor = $event)">
                  <label for="compressor" class="btn btn-outline-secondary border-2 me-2">
                    Query<br />Compression
                  </label>
                  <input type="radio" class="btn-check" id="rerank" name="rerank" value="rerank" #augmentor="ngModel"
                    [ngModel]="editCognaData && editCognaData.augmentor"
                    (ngModelChange)="editCognaData && (editCognaData.augmentor = $event)">
                  <label for="rerank" class="btn btn-outline-secondary border-2 me-2">
                    Cohere<br />Re-Rank
                  </label>
                </div>
              </div>
            </div>
            @if (editCognaData.augmentor=='rerank'){
            <div class="row">
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label">Cohere API Key *</label>
                  <input type="text" class="form-control"
                    [ngModel]="editCognaData.data && editCognaData.data.cohereApiKey"
                    (ngModelChange)="editCognaData.data && (editCognaData.data.cohereApiKey = $event)"
                    #cohereApiKey="ngModel" name="cohereApiKey" required>
                </div>
              </div>
              <div class="col-6">
                <div class="form-group mb-3">
                  <label class="form-label">Re-Rank Min Score *</label>
                  <input type="number" class="form-control"
                    [ngModel]="editCognaData.data && editCognaData.data.reRankMinScore"
                    (ngModelChange)="editCognaData.data && (editCognaData.data.reRankMinScore = $event)"
                    #reRankMinScore="ngModel" name="reRankMinScore" required>
                </div>
              </div>

            </div>
            }

            <div class="form-group mb-3">
              <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="withMetadata"
                  [ngModel]="editCognaData.data && editCognaData.data.withMetadata"
                  (ngModelChange)="editCognaData.data && (editCognaData.data.withMetadata = $event)"
                  name="withMetadata">
                <label class="form-check-label" for="withMetadata">Include metadata in query</label>
              </div>
            </div>
            @if(editCognaData.data?.withMetadata){
            <div class="form-group mb-3">
              <label class="form-label">Metadata to include (comma-separated) *</label>
              <input type="text" class="form-control" [ngModel]="editCognaData.data && editCognaData.data.metadataKeys"
                (ngModelChange)="editCognaData.data && (editCognaData.data.metadataKeys = $event)"
                #metadataKeys="ngModel" name="metadataKeys" placeholder="ie: file_name, index, file_url" required>
            </div>
            }
          </ng-template>
        </div>
      </div>
    </div>
    }
    @if(['txtgen'].includes(editCognaData.type) || (['txtcls'].includes(editCognaData.type) &&
    !editCognaData.data?.txtclsLlm)){
    <div ngbAccordionItem>
      <h2 ngbAccordionHeader>
        <button type="button" class="p-3" ngbAccordionButton>
          <div class="accordion-index">5</div>
          <div>Vector Database
            <div class="small fst-italic">Setup vector store/db to store your vectorize data</div>
          </div>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody class="p-3">
          <ng-template>
            <div class="form-group mb-3">
              <label class="form-label">Select Vector Store/Database Type *</label>
              <div>
                <div name="lang" class="text-dark">
                  <input type="radio" class="btn-check" id="db_milvus" name="milvus" value="milvus"
                    #vectorStore="ngModel" [ngModel]="editCognaData && editCognaData.vectorStoreType"
                    (ngModelChange)="editCognaData && (editCognaData.vectorStoreType = $event)" [required]="true"
                    [disabled]="!allowedVectorStoreType.includes('milvus')">
                  <label for="db_milvus" class="btn btn-outline-secondary border-2 me-2" style="min-width:100px">
                    <img [src]="dbMap['milvus'].logo" height="30">
                    <br />
                    Milvus
                  </label>
                  <input type="radio" class="btn-check" id="db_chromadb" name="chromadb" value="chromadb"
                    #vectorStore="ngModel" [ngModel]="editCognaData && editCognaData.vectorStoreType"
                    (ngModelChange)="editCognaData && (editCognaData.vectorStoreType = $event)" [required]="true"
                    [disabled]="!allowedVectorStoreType.includes('inmemory')">
                  <label for="db_chromadb" class="btn btn-outline-secondary border-2 me-2" style="min-width:100px">
                    <img [src]="dbMap['chromadb'].logo" height="30">
                    <br />
                    ChromaDB
                  </label>
                  <input type="radio" class="btn-check" id="db_inmemory" name="inmemory" value="inmemory"
                    #vectorStore="ngModel" [ngModel]="editCognaData && editCognaData.vectorStoreType"
                    (ngModelChange)="editCognaData && (editCognaData.vectorStoreType = $event)" [required]="true"
                    [disabled]="!allowedVectorStoreType.includes('chromadb')">
                  <label for="db_inmemory" class="btn btn-outline-secondary border-2 me-2" style="min-width:100px">
                    <img [src]="dbMap['inmemory'].logo" height="30">
                    <br />
                    InMemory
                  </label>
                  <!-- <input type="radio" class="btn-check" id="db_es" name="es" value="es"
                      #vectorStore="ngModel" [(ngModel)]="editCognaData && editCognaData.vectorStoreType" [required]="true"
                      disabled>
                      <label for="db_es" class="btn btn-outline-secondary border-2 me-2">
                        ElasticSearch
                    </label> -->
                </div>
              </div>
              @if (editCognaData.vectorStoreType=='inmemory'){
              <div class="small text-danger mt-2">
                Embedding will be stored in memory and will be lost on restart
              </div>
              }
              @if (vectorStore?.invalid) {
              <small class="form-text has-warning">
                @if (vectorStore?.errors?.required) {
                <span class="help-block">Vector Store/DB is required</span>
                }
              </small>
              }
            </div>

            <div class="form-check form-switch mb-3">
              <input type="checkbox" class="form-check-input" id="overrideDb"
                [ngModel]="editCognaData.data && editCognaData.data.overrideDb"
                (ngModelChange)="editCognaData.data && (editCognaData.data.overrideDb = $event)" name="overrideDb">
              <label class="form-check-label" for="overrideDb">Override Vector DB Configuration</label>
            </div>

            @if(editCognaData.vectorStoreType){
            <div class="row">
              <div class="col">
                <div class="form-group mb-3">
                  <label class="form-label">Max Result</label>
                  <input type="number" class="form-control" [ngModel]="editCognaData && editCognaData.embedMaxResult"
                    (ngModelChange)="editCognaData && (editCognaData.embedMaxResult = $event)" #embedMaxResult="ngModel"
                    name="embedMaxResult">
                </div>
              </div>
              <div class="col">
                <div class="form-group mb-3">
                  <label class="form-label">Min Score</label>
                  <input type="number" class="form-control" [ngModel]="editCognaData && editCognaData.embedMinScore"
                    (ngModelChange)="editCognaData && (editCognaData.embedMinScore = $event)" #embedMinScore="ngModel"
                    name="embedMinScore">
                </div>
              </div>
            </div>
            }
            @if (editCognaData.data.overrideDb){
            <div class="row">
              <div class="col-sm-6">
                <div class="form-group mb-3">
                  <label class="form-label">Hostname</label>
                  <input type="text" class="form-control" [ngModel]="editCognaData && editCognaData.vectorStoreHost"
                    (ngModelChange)="editCognaData && (editCognaData.vectorStoreHost = $event)" name="vectorStoreHost"
                    required>
                </div>
              </div>
              <div class="col-sm-3">
                <div class="form-group mb-3">
                  <label class="form-label">Port</label>
                  <input type="number" class="form-control" [ngModel]="editCognaData && editCognaData.vectorStorePort"
                    (ngModelChange)="editCognaData && (editCognaData.vectorStorePort = $event)" name="vectorStorePost"
                    required>
                </div>
              </div>
              <div class="col-sm-3">
                <div class="form-group mb-3">
                  <label class="form-label">Dimension</label>
                  <input type="number" class="form-control" [ngModel]="editCognaData && editCognaData.vectorStoreDim"
                    (ngModelChange)="editCognaData && (editCognaData.vectorStoreDim = $event)" name="vectorStoreDim"
                    required>
                </div>
              </div>
            </div>
            }
          </ng-template>
        </div>
      </div>
    </div>
    }
  </div>

  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round" (click)="d()">Close</button>
    <button type="button" class="btn btn-round btn-primary" [disabled]="cognaEditForm.invalid"
      (click)="c(editCognaData)">
      <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
      Save Cogna
    </button>
  </div>
</ng-template>

<ng-template #editCognaSrcTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">{{editSrcData.id?'Edit':'Add'}} Knowledge Source</h4>
  </div>
  <div class="modal-body fix-gutter" #cognaSrcEditForm="ngForm" ngForm>
    <div class="form-group mb-3">
      <label class="form-label">Source Type *</label>
      <div>
        <div name="src" class="text-dark">
          <input type="radio" class="btn-check" id="type-dataset" name="type" #srcType="ngModel"
            [(ngModel)]="editSrcData.type" value="dataset" [required]="true">
          <label for="type-dataset" class="btn btn-outline-secondary border-2 me-2">
            Dataset
          </label>
          @if(cogna.type=='txtgen'){
          <input type="radio" class="btn-check" id="type-bucket" name="type" #srcType="ngModel"
            [(ngModel)]="editSrcData.type" value="bucket" [required]="true">
          <label for="type-bucket" class="btn btn-outline-secondary border-2 me-2">
            Bucket
          </label>
          <input type="radio" class="btn-check" id="type-url" name="type" #srcType="ngModel"
            [(ngModel)]="editSrcData.type" value="url" [required]="true">
          <label for="type-url" class="btn btn-outline-secondary border-2 me-2">
            Website
          </label>
          }
        </div>
      </div>
      @if (srcType?.invalid) {
      <small class="form-text has-warning">
        @if (srcType?.errors?.required) {
        <span class="help-block">Source type is required</span>
        }
      </small>
      }
    </div>

    @if (['bucket','dataset'].indexOf(editSrcData.type)>-1){
    <div class="form-group mb-3">
      <label class="form-label">Select App</label>
      <select class="form-select" name="appId" (change)="loadOtherAppList(editSrcData.type,editSrcData.appId)"
        [(ngModel)]="editSrcData.appId">
        @for (app of otherAppList; track app.id) {
        <option [ngValue]="app.id">{{app.title}}</option>
        }
      </select>
    </div>
    }

    @if (editSrcData.type=='dataset') {
    <p>Note: Cogna will run the dataset and ingest the resulted data after transformed with the provided sentence
      template</p>
    <!-- @if(!editSrcData.id){ // WHY THESE???? -->
    <div class="form-group mb-3">
      <label class="form-label">Select Dataset *</label>
      <select class="form-select" name="srcId" (change)="loadDataset(editSrcData.srcId)"
        [ngModel]="editSrcData && editSrcData.srcId" (ngModelChange)="editSrcData && (editSrcData.srcId = $event)"
        required #mPicker>
        <option value="" disabled>Select dataset...</option>
        @for (dataset of datasetList; track $index){
        <option [ngValue]="dataset.id">{{dataset.title}}
          [{{dataset.id}}]
        </option>
        }
      </select>
    </div>
    <!-- } -->

    <!-- @if (['static','modelPicker','select'].indexOf(editItemData.type)>-1) { -->
    <div class="form-group mb-3">
      <label class="form-label d-block">Sentence Template</label>
      @for (k of dataset?.items; track $index) {
      <button type="button" class="btn btn-sm small mb-1 me-1 p-1 btn-outline-secondary"
        (click)="insertTextAtCursor('$.'+k.code, codeeditor)">{{k.label}}</button>
      }
      @if (dataset?.items) {
      @for (k of builtInVar; track $index) {
      <button type="button" class="btn btn-sm small mb-1 me-1 p-1 btn-outline-secondary"
        (click)="insertTextAtCursor(k.var, codeeditor)">{{k.label}}</button>
      }
      }
    </div>
    <div class="mx-n2 mb-3">
      <app-cm id="codeeditor" name="codeeditor" lang="html" #codeeditor [extraAutoComplete]="extraAutoCompleteHtml"
        [(ngModel)]="editSrcData.sentenceTpl" [linenumber]="true" subType="mailer"
        placeholder="Create a sentence using values in dataset">
      </app-cm>
    </div>
    @if (cogna.type=='txtcls'){
    <div class="form-group mb-3">
      <label class="form-label d-block">Category Template</label>
      @for (k of dataset?.items; track k.id) {
      <button type="button" class="btn btn-sm small mb-1 me-1 p-1 btn-outline-secondary"
        (click)="insertTextAtCursor('$.'+k.code, cateditor)">{{k.label}}</button>
      }
      @if (dataset?.items) {
      @for (k of builtInVar; track $index) {
      <button type="button" class="btn btn-sm small mb-1 me-1 p-1 btn-outline-secondary"
        (click)="insertTextAtCursor(k.var, cateditor)">{{k.label}}</button>
      }
      }
    </div>
    <div class="mx-n2 mb-3">
      <app-cm id="cateditor" name="cateditor" lang="html" #cateditor [extraAutoComplete]="extraAutoCompleteHtml"
        [(ngModel)]="editSrcData.categoryTpl" [linenumber]="true" subType="mailer"
        placeholder="Create a category using values in dataset">
      </app-cm>
    </div>
    }

    }

    @if (editSrcData.type=='bucket') {
    <p>Note: Cogna will crawl and ingest any file with the supported format (pdf, docx, pptx, xlsx and txt)</p>
    <div class="form-group mb-3">
      <label class="form-label">Select Bucket *</label>
      <select class="form-select" name="bucketId" (change)="loadBucket(editSrcData.srcId)"
        [ngModel]="editSrcData && editSrcData.srcId" (ngModelChange)="editSrcData && (editSrcData.srcId = $event)"
        required>
        <option value="" disabled>Select bucket...</option>
        @for (bucket of bucketList; track $index) {
        <option [ngValue]="bucket.id">{{bucket.name}}
          [{{bucket.id}}]
        </option>
        }
      </select>
    </div>
    }
    @if (editSrcData.type=='url') {
    <p>Note: Cogna will try to read and ingest the content of the website</p>
    <div class="form-group mb-3">
      <label class="form-label">Please specify the web URL</label>
      <input type="text" class="form-control" [ngModel]="editSrcData && editSrcData.srcUrl"
        (ngModelChange)="editSrcData && (editSrcData.srcUrl = $event)" #srcUrl="ngModel" name="srcUrl"
        placeholder="ie: https://www.unimas.my/" required>
    </div>
    }


    <div class="form-check form-switch mb-3">
      <input type="checkbox" class="form-check-input" id="scheduled" [ngModel]="editSrcData && editSrcData.scheduled"
        (ngModelChange)="editSrcData && (editSrcData.scheduled = $event)" name="scheduled">
      <label class="form-check-label" for="scheduled">Scheduled Run</label>
    </div>


    @if (editSrcData.scheduled) {
    <div class="form-group mb-3">
      <label class="form-label">Ingest Frequency *</label>
      <div>
        <div class="form-check form-check-inline">
          <input type="radio" id="freqDaily" [ngModel]="editSrcData && editSrcData.freq"
            (ngModelChange)="editSrcData && (editSrcData.freq = $event)" name="freqDaily" value="daily"
            class="form-check-input">
          <label class="form-check-label" for="freqDaily">Daily</label>
        </div>
        <div class="form-check form-check-inline">
          <input type="radio" id="freqWeekly" [ngModel]="editSrcData && editSrcData.freq"
            (ngModelChange)="editSrcData && (editSrcData.freq = $event)" name="freqWeekly" value="weekly"
            class="form-check-input">
          <label class="form-check-label" for="freqWeekly">Weekly</label>
        </div>
        <div class="form-check form-check-inline">
          <input type="radio" id="freqMonthly" [ngModel]="editSrcData && editSrcData.freq"
            (ngModelChange)="editSrcData && (editSrcData.freq = $event)" name="freqMonthly" value="monthly"
            class="form-check-input">
          <label class="form-check-label" for="freqMonthly">Monthly</label>
        </div>
        <div class="form-check form-check-inline">
          <input type="radio" id="freqYearly" [ngModel]="editSrcData && editSrcData.freq"
            (ngModelChange)="editSrcData && (editSrcData.freq = $event)" name="freqYearly" value="yearly"
            class="form-check-input">
          <label class="form-check-label" for="freqYearly">Yearly</label>
        </div>
        <input type="hidden" [ngModel]="editSrcData && editSrcData.freq"
          (ngModelChange)="editSrcData && (editSrcData.freq = $event)" name="freqHdn" required>
      </div>
    </div>
    <div class="row">
      @if (editSrcData?.freq=='weekly') {
      <div class="col-sm-6">
        <div class="form-group mb-3">
          <label class="form-label">Day of week *</label>
          <select class="form-select" name="dayOfWeak" [ngModel]="editSrcData && editSrcData.dayOfWeek"
            (ngModelChange)="editSrcData && (editSrcData.dayOfWeek = $event)" #dayOfWeek="ngModel" required>
            <!-- <option value="" disabled>Select day...</option> -->
            @for (item of dayOfWeekList; track $index) {
            <option [value]="item.value">{{item.name}}
            </option>
            }
          </select>
          @if (dayOfWeek?.invalid) {
          <small class="form-text has-warning">
            @if (dayOfWeek?.errors?.required) {
            <span class="help-block">Day of week is required</span>
            }
          </small>
          }
        </div>
      </div>
      }
      @if (['monthly','yearly'].indexOf(editSrcData?.freq)>-1) {
      <div class="col-sm-6">
        <div class="form-group mb-3">
          <label class="form-label">Day of month *</label>
          <select class="form-select" name="dayOfMonth" [ngModel]="editSrcData && editSrcData.dayOfMonth"
            (ngModelChange)="editSrcData && (editSrcData.dayOfMonth = $event)" #dayOfMonth="ngModel" required>
            @for (item of dayOfMonthList; track $index) {
            <option [value]="item">{{item}}
            </option>
            }
          </select>
          @if (dayOfMonth?.invalid) {
          <small class="form-text has-warning">
            @if (dayOfMonth?.errors?.required) {
            <span class="help-block">Day of month is
              required</span>
            }
          </small>
          }
        </div>
      </div>
      }
      @if (editSrcData?.freq=='yearly') {
      <div class="col-sm-6">
        <div class="form-group mb-3">
          <label class="form-label">Month of year *</label>
          <select class="form-select" name="monthOfYear" [ngModel]="editSrcData && editSrcData.monthOfYear"
            (ngModelChange)="editSrcData && (editSrcData.monthOfYear = $event)" #monthOfYear="ngModel" required>
            <!-- <option value="" disabled>Select date...</option> -->
            @for (item of monthOfYearList; track $index) {
            <option [value]="item.value">{{item.name}}
            </option>
            }
          </select>
          @if (monthOfYear?.invalid) {
          <small class="form-text has-warning">
            @if (monthOfYear?.errors?.required) {
            <span class="help-block">Month of year is
              required</span>
            }
          </small>
          }
        </div>
      </div>
      }
      <div class="col-sm-6">
        <div class="form-group mb-3">
          <label class="form-label">Hour in day (minute set to 00)*</label>
          <input type="text" class="form-control" [ngModel]="editSrcData && editSrcData.clock"
            (ngModelChange)="editSrcData && (editSrcData.clock = $event)" #clock="ngModel" placeholder="ie: 1400"
            maxlength="4" name="clock" (keyup)="keepMinute00(editSrcData)" required>
          @if (clock?.invalid) {
          <small class="form-text has-warning">
            @if (clock?.errors?.required) {
            <span class="help-block">Clock is required in HHmm (ie: 0800
              or 1400)</span>
            }
          </small>
          }
        </div>
      </div>
    </div>
    }
  </div>
  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round" (click)="d()">Close</button>
    <button type="button" class="btn btn-round btn-primary" [disabled]="cognaSrcEditForm.invalid"
      (click)="c(editSrcData)">
      <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
      Save Source
    </button>
  </div>
</ng-template>

<ng-template #editCognaToolTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">{{editToolData.id?'Edit':'Add'}} Tool</h4>
  </div>
  <div class="modal-body fix-gutter" #cognaToolEditForm="ngForm" ngForm>

    <div class="mb-1">
      <label class="form-label">Tool Name *</label>
      <input type="text" class="form-control" [(ngModel)]="editToolData.name" #name="ngModel"
        (ngModelChange)="editToolData.name=toSnakeCase(editToolData.name)" name="name" required>
      @if (name?.invalid) {
      <small class="form-text has-warning">
        @if (name?.errors?.required) {
        <span class="help-block">Name is required</span>
        }
      </small>
      }
    </div>
    <div class="mb-3">
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="enabled" [(ngModel)]="editToolData.enabled" name="enabled">
        <label class="form-check-label" for="enabled">Tool Enabled</label>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">Description *</label>
      <textarea class="form-control" [(ngModel)]="editToolData.description" name="description" required></textarea>
    </div>

    <div class="form-group mb-3">
      <label class="form-label">Select App</label>
      <select class="form-select" name="appId" (change)="getLambdaList(editToolData.appId)"
        [(ngModel)]="editToolData.appId">
        @for (app of otherAppList; track app.id) {
        <option [ngValue]="app.id">{{app.title}}</option>
        }
      </select>
    </div>

    <!-- @if (editSrcData.type=='bucket') {
      <p>Note: Cogna will crawl and ingest any file with the supported format (pdf, docx, pptx, xlsx and txt)</p> -->
    <div class="form-group mb-3">
      <label class="form-label">Select Lambda *</label>
      <select class="form-select mb-3" name="lambdaId" [(ngModel)]="editToolData.lambdaId" required>
        <option value="" disabled>Select lambda...</option>
        @for (lambda of lambdaList; track $index){
        <option [ngValue]="lambda.id">{{lambda.name}}
          [{{lambda.id}}]
        </option>
        }
      </select>
    </div>
    <!-- <div class="form-group mb-3">
        <label class="form-label">Select Lambda *</label>
        <ng-select [items]="lambdaList" bindLabel="name" bindValue="id" placeholder="No lambda"
          [ngModel]="editToolData.lambdaId" (ngModelChange)="editToolData && (editToolData.lambdaId = $event)" name="lambdaId">
        </ng-select>
      </div> -->

    <label class="form-label">Tool Parameters</label>

    <div class="list-group">
      <!-- <div class="list-group-item small">
          Tool Parameters
        </div> -->
      @if(editToolData.params && editToolData.params.length>0){
      @for(p of editToolData.params; track $index){
      @if (paramEdit[$index]){
      <div class="list-group-item p-3 bg-light">
        <div class="mb-2">
          <label class="form-label small">Parameter Key</label>
          <input type="text" class="form-control form-control-sm" [(ngModel)]="p.key"
            (ngModelChange)="p.key=toSnakeCase(p.key)" name="parameterKeyEdit_{{p.key}}">
        </div>
        <div class="mb-2">
          <label class="form-label small">Parameter Description</label>
          <textarea class="form-control form-control-sm" [(ngModel)]="p.description"
            name="parameterDescEdit_{{p.key}}"></textarea>
        </div>
        <div class="mb-2">
          <div class="form-check small">
            <input type="checkbox" class="form-check-input" id="paramRequired" [(ngModel)]="p.required"
              name="paramRequired">
            <label class="form-check-label" for="paramRequired">Required parameter</label>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" (disabled)="!(p.key&&p.description)"
          (click)="paramEdit[$index]=false">Save Parameter</button>
      </div>
      }@else {
      <div class="list-group-item">
        <button class="btn btn-sm float-end">
          <fa-icon [icon]="['fas','trash']" [fixedWidth]="true" (click)="removeToolParam($index)">
          </fa-icon>
        </button>
        <button class="btn btn-sm float-end" (click)="paramEdit[$index]=true">
          <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true">
          </fa-icon>
        </button>
        <div class="fw-bold">{{p.key}} @if (p.required){<sup>*</sup>}</div>
        <div class="small">{{p.description}}</div>
      </div>
      }
      }
      }@else {
      <div class="list-group-item">
        <div class="fs-5 text-muted text-center p-3">No parameter specified</div>
      </div>
      }
      @if (!isParamEdit()){
      <div class="list-group-item p-3 bg-light">
        <div class="fw-bold mb-2">Add new parameter</div>
        <div class="mb-2">
          <label class="form-label small">Parameter Key</label>
          <input type="text" class="form-control form-control-sm" [(ngModel)]="parameterKey" #name="ngModel"
            (ngModelChange)="parameterKey=toSnakeCase(parameterKey)" name="parameterKey">
        </div>
        <div class="mb-2">
          <label class="form-label small">Parameter Description</label>
          <textarea class="form-control form-control-sm" [(ngModel)]="parameterDesc" name="parameterDesc"></textarea>
        </div>
        <div class="mb-2">
          <div class="form-check small">
            <input type="checkbox" class="form-check-input" id="paramRequired" [(ngModel)]="parameterRequired"
              name="paramRequired">
            <label class="form-check-label" for="paramRequired">Required parameter</label>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" (disabled)="!(parameterKey&&parameterDesc)"
          (click)="addToolParam({key:parameterKey, description:parameterDesc, required: parameterRequired})">Add
          Parameter</button>
      </div>
      }
    </div>
  </div>
  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round" (click)="d()">Close</button>
    <button type="button" class="btn btn-round btn-primary" [disabled]="cognaToolEditForm.invalid"
      (click)="c(editToolData)">
      <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
      Save Tool
    </button>
  </div>
</ng-template>

<ng-template #editCognaMcpTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">{{editMcpData.id?'Edit':'Add'}} MCP Server</h4>
  </div>
  <div class="modal-body fix-gutter" #cognaMcpEditForm="ngForm" ngForm>

    <div class="mb-1">
      <label class="form-label">Server Name *</label>
      <input type="text" class="form-control" [(ngModel)]="editMcpData.name" #name="ngModel"
        (ngModelChange)="editMcpData.name=toSnakeCase(editMcpData.name)" name="name" required>
      @if (name?.invalid) {
      <small class="form-text has-warning">
        @if (name?.errors?.required) {
        <span class="help-block">Name is required</span>
        }
      </small>
      }
    </div>
    <div class="mb-3">
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="enabled" [(ngModel)]="editMcpData.enabled" name="enabled">
        <label class="form-check-label" for="enabled">MCP Server Enabled</label>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">URL *</label>
      <input type="text" class="form-control" [(ngModel)]="editMcpData.url" #mcpUrl="ngModel" name="mcpUrl" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Timeout (in seconds)</label>
      <input type="number" class="form-control" [(ngModel)]="editMcpData.timeout" #timeout="ngModel" name="timeout"
        required>
    </div>

  </div>
  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round" (click)="d()">Close</button>
    <button type="button" class="btn btn-round btn-primary" [disabled]="cognaMcpEditForm.invalid"
      (click)="c(editMcpData)">
      <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
      Save MCP Server
    </button>
  </div>
</ng-template>

<ng-template #editCognaSubTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Add Sub Agent</h4>
  </div>
  <div class="modal-body fix-gutter" #cognaSubEditForm="ngForm" ngForm>

    <div class="mb-1">
      <label class="form-label">Sub Agent Name *</label>
      <input type="text" class="form-control" [(ngModel)]="editSubData.name" #name="ngModel"
        (ngModelChange)="editSubData.name=toSnakeCase(editSubData.name)" name="name" required>
      @if (name?.invalid) {
      <small class="form-text has-warning">
        @if (name?.errors?.required) {
        <span class="help-block">Name is required</span>
        }
      </small>
      }
    </div>
    <div class="mb-3">
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="enabled" [(ngModel)]="editSubData.enabled" name="enabled">
        <label class="form-check-label" for="enabled">Sub Agent Enabled</label>
      </div>
    </div>
    <div class="form-group mb-3">
      <label class="form-label">Select App</label>
      <select class="form-select" name="appId" (change)="getOtherCognaList(editSubData.appId)"
        [(ngModel)]="editSubData.appId">
        @for (app of otherAppList; track app.id) {
        <option [ngValue]="app.id">{{app.title}}</option>
        }
      </select>
    </div>
    <div class="form-group mb-3">
      <label class="form-label">Select Cogna *</label>
      <select class="form-select" name="subId" [(ngModel)]="editSubData.subId" required #mSubPicker>
        <option value="" disabled>Select cogna...</option>
        @for (cogna of otherCognaList; track $index){
        <option [ngValue]="cogna.id">{{cogna.name}}
          [{{cogna.id}}]
        </option>
        }
      </select>
    </div>
  </div>
  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round" (click)="d()">Close</button>
    <button type="button" class="btn btn-round btn-primary" [disabled]="cognaSubEditForm.invalid"
      (click)="c(editSubData)">
      <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
      Save Sub Agent
    </button>
  </div>
</ng-template>

<ng-template #viewChatHistoryTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">View Chat History</h4>
  </div>

  <div class="bg-light p-2">
    <div class="input-group" ngbDropdown>
      <input type="search" autocapitalize="none" class="form-control" placeholder="Start typing to search..."
        [(ngModel)]="chatHistorySearchText" (keyup.enter)="loadChatHistory(cogna.id,chatHistoryPageNumber)">
      <a type="button" class="btn btn-outline-secondary" title="Export Log"
        href="{{baseApi}}/cogna/{{cogna.id}}/export-log-csv" target="_blank">
        <fa-icon [icon]="['fas','file-export']" [fixedWidth]="true"></fa-icon>
      </a>

      <button type="button" class="btn btn-outline-secondary" id="dropdownFormChatHistory" title="Select Status"
        ngbDropdownToggle>
        <fa-icon [icon]="['fas','filter']" [fixedWidth]="true"></fa-icon>
      </button>
      <div ngbDropdownMenu aria-labelledby="dropdownFormChatHistory">
        <div class="px-2">
          <label class="small">Page Size</label>
          <div class="btn-group float-end">
            @for (i of [15,25,50,100]; track i) {
            <input class="btn-check" type="radio" [value]="i" id="tpagesize-{{i}}" name="tpagesize-{{i}}"
              (click)="loadChatHistory(cogna.id,1, i)" [(ngModel)]="chatHistoryPageSize">
            <label for="tpagesize-{{i}}" class="btn btn-outline-secondary btn-sm">{{i}}</label>
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered mt-3 table-sm small">
      <thead>
        <tr>
          <th>Type</th>
          <th>Prompt</th>
          <th>Response</th>
          <th>Email</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody>
        @for (item of chatHistoryList; track $index) {
        <tr>
          <td>{{item.type}}</td>
          <td>{{item.text}}</td>
          <td>{{item.response}}</td>
          <td>{{item.email}}</td>
          <td>{{item.timestamp|date:'yy-MM-d HH:mm:ss'}}</td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  @if (chatHistoryTotal>chatHistoryPageSize) {
  <div class="text-center d-flex justify-content-center pagination-rounded p-1 print-hide">
    <ngb-pagination [collectionSize]="chatHistoryTotal" [pageSize]="chatHistoryPageSize"
      [(page)]="chatHistoryPageNumber" [maxSize]="10" [rotate]="true"
      (pageChange)="loadChatHistory(cogna.id, chatHistoryPageNumber)" boundaryLinks="true" directionLinks="true">
      <ng-template ngbPaginationFirst>
        <fa-icon [icon]="['fas','angle-double-left']"></fa-icon>
      </ng-template>
      <ng-template ngbPaginationPrevious>
        <fa-icon [icon]="['fas','chevron-left']"></fa-icon>
      </ng-template>
      <ng-template ngbPaginationNext>
        <fa-icon [icon]="['fas','chevron-right']"></fa-icon>
      </ng-template>
      <ng-template ngbPaginationLast>
        <fa-icon [icon]="['fas','angle-double-right']"></fa-icon>
      </ng-template>
    </ngb-pagination>
  </div>
  }
  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round" (click)="d()">Close</button>
  </div>
</ng-template>

<ng-template #searchDbTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Vector DB Query</h4>
  </div>
  <div class="modal-body">
    <div class="row">
      <div class="col-sm-4 mb-3">
        <img [src]="dbMap[cogna.vectorStoreType]?.logo" height="20" />
        <div class="mt-3 fw-bold">{{dbMap[cogna.vectorStoreType]?.name}}</div>
      </div>
      <div class="col-sm-4">
        <div class="form-group mb-3">
          <label class="form-label">Max Result * - {{searchDbData.maxResult}}</label>
          <input type="range" class="form-range" [ngModel]="searchDbData && searchDbData.maxResult"
            (ngModelChange)="searchDbData && (searchDbData.maxResult = $event)"
            (change)="searchDb(cogna.id, searchDbData)" min="0" max="10" #maxResult="ngModel" name="maxResult" required>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="form-group mb-3">
          <label class="form-label">Min Score * - {{searchDbData.minScore}}</label>
          <input type="number" class="form-control" [ngModel]="searchDbData && searchDbData.minScore"
            (ngModelChange)="searchDbData && (searchDbData.minScore = $event)"
            (change)="searchDb(cogna.id, searchDbData)" min="0" max="100" #minScore="ngModel" name="minScore" required>
        </div>
      </div>
      <div class="form-group mb-3">
        <label class="form-label">Search/Prompt</label>
        <div class="input-group">
          <input type="text" class="form-control" (keyup.enter)="searchDb(cogna.id, searchDbData)" autocapitalize="none"
            [ngModel]="searchDbData && searchDbData.search"
            (ngModelChange)="searchDbData && (searchDbData.search = $event)" #searchDbText="ngModel" name="searchDbText"
            required>
          <button type="button" class="btn btn-primary" style="height:38px; min-width:38px"
            [disabled]="!searchDbData.search?.trim()" (click)="searchDb(cogna.id, searchDbData)">
            <fa-icon [icon]="['fas','paper-plane']"></fa-icon>
          </button>
        </div>

      </div>


    </div>

  </div>
  <div class="list-group list-group-flush">
    @for (item of searchDbList(); track $index) {
    <div class="list-group-item">
      <div class="mb-2 fw-bold">Result Score: {{item.score}} </div>
      <div class="small" [innerHTML]="nl2br(imagify(linkify(item.text)))"></div>
      @if (!isEmptyObject(item.metadata)){
      <div class="table-responsive">
        <table class="table table-bordered mt-3 table-sm small">
          <tbody>
            @for(m of item.metadata|keyvalue; track $index){
            <tr>
              <td width="5%">{{m.key}}</td>
              <td>{{m.value}}</td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }

    </div>
    }
  </div>
  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round" (click)="d()">Close</button>
  </div>
</ng-template>