<div class="fix-gutter">
  <div class="p-2">
    <!-- @if (screenList?.length==0) {
      <div class="m-a col-sm-12">
        <div class="p-4 text-muted text-center">
          <h1>:(</h1>
          <h4>No custom screen specified</h4>
        </div>
      </div>
    }
    @if (screenList?.length>0 && !curScreen) {
      <div class="m-a col-sm-12" style="color:#aaa;">
        <div class="p-4 text-muted text-center">
          <h4>Please select screen above</h4>
        </div>
      </div>
    } -->
    @if (curScreen) {
      <div class="mb-2">
        <div class="limit-width">
          <div class="py-2">
            <div class="d-flex flex-column">
              <div class="me-auto d-flex flex-row w-100 mb-2">
                <h5 class="m-0 text-truncate">{{cleanText(curScreen.title)}} <sup>{{curScreen.id}}</sup></h5>
                <div class="ms-2 text-truncate align-bottom text-muted">{{cleanText(curScreen.description)}}
                </div>
              </div>
              <div class="d-flex align-items-baseline">
                <div class="me-auto mt-2">
                  <!-- @switch(curScreen.type){
                    @case ('qr'){

                    }
                    @case ('list'){

                    }
                    @case ('page'){

                    }
                    @case ('static'){

                    }
                    @case ('calendar'){

                    }
                  } -->
                  @if (curScreen.type == 'qr') {
                    <span>
                      <fa-icon [icon]="['fas','qrcode']" [fixedWidth]="true"></fa-icon>
                      QR Scanner
                    </span>
                  }
                  @if (curScreen.type == 'list') {
                    <span>
                      <fa-icon [icon]="['far','file-code']" [fixedWidth]="true"></fa-icon>
                      Entry List
                    </span>
                  }
                  @if (curScreen.type == 'page') {
                    <span>
                      <fa-icon [icon]="['far','file-code']" [fixedWidth]="true"></fa-icon>
                      Entry Page
                    </span>
                  }
                  @if (curScreen.type == 'static') {
                    <span>
                      <fa-icon [icon]="['far','file-code']" [fixedWidth]="true"></fa-icon>
                      Static Page
                    </span>
                  }
                  @if (curScreen.type == 'calendar') {
                    <span>
                      <fa-icon [icon]="['far','calendar-alt']" [fixedWidth]="true"></fa-icon>
                      Calendar
                    </span>
                  }
                  @if (curScreen.type == 'prompt') {
                    <span>
                      <fa-icon [icon]="['far','file']" [fixedWidth]="true"></fa-icon>
                      Prompt Box
                    </span>
                  }
                  @if (curScreen.type == 'chatbot') {
                    <span>
                      <fa-icon [icon]="['far','file']" [fixedWidth]="true"></fa-icon>
                      Cogna Chatbot
                    </span>
                  }
                  @if (curScreen.type == 'bucket') {
                    <span>
                      <fa-icon [icon]="['fas','box']" [fixedWidth]="true"></fa-icon>
                      Bucket Screen
                    </span>
                  }
                  @if (curScreen.type == 'map') {
                    <span>
                      <fa-icon [icon]="['fas','map-marked-alt']" [fixedWidth]="true"></fa-icon>
                      Map Screen
                    </span>
                  }
                  @if (curScreen.type == 'mailbox') {
                    <span>
                      <fa-icon [icon]="['fas','inbox']" [fixedWidth]="true"></fa-icon>
                      Mailbox Screen
                    </span>
                  }
                  @if (curScreen.type == 'combine') {
                    <span>
                      <fa-icon [icon]="['fas','table']" [fixedWidth]="true"></fa-icon>
                      Combined Screen
                    </span>
                  }
                </div>
                <div>
                  <button type="button" class="btn btn-sm border border-2 ms-1"
                    (click)="editScreen(editScreenTpl,curScreen, false)">
                    <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true"></fa-icon>
                  </button>
                  <button type="button" class="btn btn-sm border border-2 btn-outline-danger ms-1 me-1"
                    (click)="removeScreen(removeScreenTpl,curScreen)">
                    <fa-icon [icon]="['fas','trash']" [fixedWidth]="true"></fa-icon>
                  </button>
                  <a class="btn btn-sm border border-2 border-success btn-outline-success"
                    routerLink="/run/{{app?.id}}/screen/{{curScreen.id}}">
                    <fa-icon [icon]="['fas','play']" [fixedWidth]="true"></fa-icon>
                  </a>
                </div>
              </div>
            </div>
          </div>
          <div class="text-white bg-danger p-3 d-none mb-2"
            [class.d-block]="curScreen.type=='page' && !curScreen.form?.id">
            <fa-icon [icon]="['fas','exclamation-triangle']" [fixedWidth]="true"></fa-icon>
            No form found associated with this screen. It might has been removed.
          </div>
          <div class="text-white bg-danger p-3 d-none mb-2"
            [class.d-block]="curScreen.type=='list' && !curScreen.dataset?.id">
            <fa-icon [icon]="['fas','exclamation-triangle']" [fixedWidth]="true"></fa-icon>
            No dataset found associated with this screen. It might has been removed.
          </div>
          <div class="text-white bg-danger p-3 d-none mb-2"
            [class.d-block]="curScreen.type=='list' && !curScreen.dataset?.form?.id">
            <fa-icon [icon]="['fas','exclamation-triangle']" [fixedWidth]="true"></fa-icon>
            Dataset associated with this screen has no form. It might has been removed.
          </div>
          <div class="text-white bg-danger p-3 d-none mb-2"
            [class.d-block]="curScreen.type=='bucket' && !curScreen?.bucket?.id">
            <fa-icon [icon]="['fas','exclamation-triangle']" [fixedWidth]="true"></fa-icon>
            Dataset associated with this screen has no form. It might has been removed.
          </div>

          @if (['list','calendar','map'].indexOf(curScreen.type)>-1 && dataset.id){
            <div class="rounded bg-secondary text-white mb-3 d-flex flex-row flex-no-wrap">
              <div class="flex-grow-1 p-2 text-truncate">
                Dataset: <strong>{{dataset.title}}</strong>
                @if (dataset.description) {
                  <div>{{dataset.description}}</div>
                }
              </div>
              <div class="p-2"><a class="btn btn-light btn-sm float-end rounded-pill text-nowrap"
              [routerLink]="['../../../'+dataset.appId+'/ui/dataset']" [queryParams]="{id:dataset.id}">View Dataset</a></div>
            </div>
          }
         @if (['bucket'].indexOf(curScreen.type)>-1 && bucket.id){
            <div class="rounded bg-secondary text-white mb-3 d-flex flex-row flex-no-wrap">
              <div class="flex-grow-1 p-2 text-truncate">
                Bucket: <strong>{{bucket?.name}}</strong>
                @if (bucket?.description) {
                  <div>{{bucket?.description}}</div>
                }
              </div>
              <div class="p-2"><a class="btn btn-light btn-sm float-end rounded-pill text-nowrap"
              [routerLink]="['../../../'+bucket.appId+'/ui/bucket']" [queryParams]="{id:bucket.id}">View Bucket</a></div>
            </div>
          }
          @if (curScreen.type=='page' && form.id){
            <div class="rounded bg-secondary text-white mb-3 d-flex flex-row flex-no-wrap">
              <div class="flex-grow-1 p-2 text-truncate">
                Form: <strong>{{form.title}}</strong>
                @if (form.description) {
                  <div>{{form.description}}</div>
                }
              </div>
              <div class="p-2"><a class="btn btn-light btn-sm float-end rounded-pill text-nowrap"
              [routerLink]="['../../../'+form.appId+'/ui/form']" [queryParams]="{id:form.id}">View Form</a></div>
            </div>
          }
  
        </div>

        @if (['static','list','page','calendar','chatbot','bucket','map','mailbox','combine', 'qr'].indexOf(curScreen.type)>-1) {
          <div class="mb-2">
            <form name="contentForm" #contentForm="ngForm" ngForm>
              <div class="card">
                <div class="card-header">
                  <ul ngbNav #nav="ngbNav" [destroyOnHide]="false"
                    class="nav-tabs nav fix-gutter card-header-tabs">
                    @if (['static','list','page','calendar','chatbot','bucket','map','mailbox','combine'].indexOf(curScreen.type)>-1) {
                      <li ngbNavItem>
                        <a class="small px-2" ngbNavLink>Content</a>
                        <ng-template ngbNavContent>
                          @if (curScreen.type=='page') {
                            <div class="bg-white p-1 pb-0 var-ph-picker">
                              @for (k of curScreen.form?.items|keyvalue; track $index) {
                                @if (curScreen.form?.items[k.key].type!='static') {
                                  <button
                                    class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                  (click)="insertTextAtCursor(getItemText('$',k.value),codeeditor())">{{k.value.label}}</button>
                                }
                              }
                              @if (curScreen.form?.prev) {
                                @for (k of curScreen.form?.prev?.items|keyvalue; track $index) {
                                  @if (curScreen.form?.prev?.items[k.key].type!='static') {
                                    <button
                                      class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                    (click)="insertTextAtCursor(getItemText('$prev$',k.value),codeeditor())">{{k.value.label}}</button>
                                  }
                                }
                              }
                              @if (curScreen.actions) {
                                @for (k of curScreen.actions; track k.id) {
                                  <button type="button" class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-info"
                                    (click)="insertTextAtCursor('\{\{$go[\''+k.id+'\']\}\}',codeeditor())">
                                    <fa-icon [icon]="['fas','cog']" [fixedWidth]="true"></fa-icon>
                                    {{k.label}}
                                  </button>
                                }
                              }
                              @for (section of form.sections; track section.id) {
                                @if (section.type=='list') {
                                  <button
                                    class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                    (click)="insertTextAtCursor(getLoopCode(section),codeeditor())">
                                    <fa-icon [icon]="['fas','th']" [fixedWidth]="true"></fa-icon>
                                    {{section.title}}
                                  </button>
                                }
                              }
                            </div>
                          }
                          @if (curScreen.type=='static') {
                            <div class="bg-white p-1 pb-0 var-ph-picker">
                              @if (curScreen.actions) {
                                @for (k of curScreen.actions; track k.id) {
                                  <button type="button" class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-info"
                                    (click)="insertTextAtCursor('\{\{$go[\''+k.id+'\']\}\}',codeeditor())">
                                    <fa-icon [icon]="['fas','cog']" [fixedWidth]="true"></fa-icon>
                                    {{k.label}}
                                  </button>
                                }
                              }
                            </div>
                          }
                          @if (curScreen.type=='list') {
                            <div class="bg-white p-1 pb-0 var-ph-picker">
                              @for (k of curScreen.dataset?.form?.items|keyvalue; track $index) {
                                @if (curScreen.dataset?.form?.items[k.key].type!='static') {
                                  <button
                                    class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                  (click)="insertTextAtCursor(getItemText('$',k.value),codeeditor())">{{k.value.label}}</button>
                                }
                              }
                              @if (curScreen.dataset?.form?.prev) {
                                @for (k of curScreen.dataset?.form?.prev?.items|keyvalue; track $index) {
                                  @if (curScreen.dataset?.form?.prev?.items[k.key].type!='static') {
                                    <button
                                      class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                    (click)="insertTextAtCursor(getItemText('$prev$',k.value),codeeditor())">{{k.value.label}}</button>
                                  }
                                }
                              }
                              @if (curScreen.actions) {
                                @for (k of curScreen.actions; track k.id) {
                                  <button type="button" class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-info"
                                    (click)="insertTextAtCursor('\{\{$go[\''+k.id+'\']\}\}',codeeditor())">
                                    <fa-icon [icon]="['fas','cog']" [fixedWidth]="true"></fa-icon>
                                    {{k.label}}
                                  </button>
                                }
                              }
                              @for (section of form.sections; track section.id) {
                                @if (section.type=='list') {
                                  <button
                                    class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                    (click)="insertTextAtCursor(getLoopCode(section),codeeditor())">
                                    <fa-icon [icon]="['fas','th']" [fixedWidth]="true"></fa-icon>
                                    {{section.title}}
                                  </button>
                                }
                              }
                            </div>
                          }
                          @if (['list','page','static'].indexOf(curScreen.type)>-1) {
                            @if (showWysiwyg) {
                              <angular-editor id="ae-content"
                                class="sc-ae"
                                [class.ae-limit-width]="!curScreen?.wide" (keydown)="onKeyDown($event)"
                                [config]="editorConfig" name="content"
                                [(ngModel)]="curScreen.data.content">
                              </angular-editor>
                            }
                            @if (!showWysiwyg) {
                              <app-cm id="codeeditor" name="content" lang="html" #codeeditor
                                (keydown)="onKeyDown($event)"
                                [(ngModel)]="curScreen.data.content"
                                [extraAutoComplete]="extraAutoCompleteHtml" [linenumber]="true">
                              </app-cm>
                            }
                            @if (['list','page'].indexOf(curScreen.type)>-1) {
                              <div class="bg-white p-2">
                                <div class="input-group input-group-sm">
                                  <span class="input-group-text">
                                    Container class
                                  </span>
                                  <input class="form-control" type="text" name="parentClass"
                                    placeholder="ie: row"
                                    [(ngModel)]="curScreen.data.parentclass">
                                </div>
                              </div>
                            }
                          }
                          @if (['calendar'].indexOf(curScreen.type)>-1) {
                            <div class="p-3">
                              <h5>Calendar Bindings</h5>
                              <div class="row">
                                <div class="col-sm-4">
                                  <div class="form-group mb-3">
                                    <label class="form-label">Title</label>
                                    <select class="form-select" name="title"
                                      [(ngModel)]="curScreen.data.title"
                                      required>
                                      <option value="" disabled>Select title field...</option>
                                      @for (k of curScreen.dataset?.form?.items|keyvalue; track $index) {
                                        <option
                                          [ngValue]="k.key">
                                          {{k.value.label}}
                                        </option>
                                      }
                                    </select>
                                  </div>
                                </div>
                                <div class="col-sm-4">
                                  <div class="form-group mb-3">
                                    <label class="form-label">Start Date</label>
                                    <select class="form-select" name="start"
                                      [(ngModel)]="curScreen.data.start"
                                      required>
                                      <option value="" disabled>Select start date field...
                                      </option>
                                      @for (k of curScreen.dataset?.form?.items|keyvalue; track $index) {
                                        <option
                                          [ngValue]="k.key"> 
                                          {{k.value.label}}
                                        </option>
                                      }
                                    </select>
                                  </div>
                                </div>
                                <div class="col-sm-4">
                                  <div class="form-group mb-3">
                                    <label class="form-label">End Date</label>
                                    <select class="form-select" name="end"
                                      [(ngModel)]="curScreen.data.end"
                                      required>
                                      <option [ngValue]="null">* Not specified</option>
                                      @for (k of curScreen.dataset?.form?.items|keyvalue; track $index) {
                                        <option
                                          [ngValue]="k.key">
                                          {{k.value.label}}
                                        </option>
                                      }
                                    </select>
                                  </div>
                                </div>

                                <div class="form-group mx-n2 mb-3">
                                  <label class="form-label">Custom Title Template</label>
                                  <div class="bg-white p-1 pb-0 var-ph-picker">
                                    @for (k of curScreen.dataset?.form?.items|keyvalue; track $index) {
                                      @if (curScreen.dataset?.form?.items[k.key].type!='static') {
                                        <button
                                          class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                        (click)="insertTextAtCursor(getItemText('$',k.value),codeeditorcalendartitle)">{{k.value.label}}</button>
                                      }
                                    }
                                    @if (curScreen.dataset?.form?.prev) {
                                      @for (k of curScreen.dataset?.form?.prev?.items|keyvalue; track $index) {
                                        @if (curScreen.dataset?.form?.prev?.items[k.key].type!='static') {
                                          <button
                                            class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                          (click)="insertTextAtCursor(getItemText('$prev$',k.value),codeeditorcalendartitle)">{{k.value.label}}</button>
                                        }
                                      }
                                    }
                                    @if (curScreen.actions) {
                                      @for (k of curScreen.actions; track k.id) {
                                        <button type="button" class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-info"
                                          (click)="insertTextAtCursor('\{\{$go[\''+k.id+'\']\}\}',codeeditorcalendartitle)">
                                          <fa-icon [icon]="['fas','cog']" [fixedWidth]="true"></fa-icon>
                                          {{k.label}}
                                        </button>
                                      }
                                    }
                                    @for (section of form.sections; track section.id) {
                                      @if (section.type=='list') {
                                        <button
                                          class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                          (click)="insertTextAtCursor(getLoopCode(section),codeeditorcalendartitle)">
                                          <fa-icon [icon]="['fas','th']" [fixedWidth]="true"></fa-icon>
                                          {{section.title}}
                                        </button>
                                      }
                                    }
                                  </div>
                                  <app-cm name="codeeditorcalendartitle" lang="html" #codeeditorcalendartitle
                                    (keydown)="onKeyDown($event)"
                                    [extraAutoComplete]="extraAutoCompleteHtml"
                                    [(ngModel)]="curScreen.data.titleTpl" [linenumber]="true" required>
                                  </app-cm>
                                </div>


                                <div class="col-sm-4">
                                  <div class="form-group mb-3">
                                    <label class="form-label">Default Calendar View</label>
                                    <select class="form-select" name="defaultView"
                                      [(ngModel)]="curScreen.data.defaultView"
                                      required>
                                      <option value="dayGridMonth" selected>
                                        Month
                                      </option>
                                      <option value="timeGridWeek">
                                        Week
                                      </option>
                                      <option value="timeGridDay">
                                        Day
                                      </option>
                                    </select>
                                  </div>
                                </div>
                              </div>
                            </div>
                          }
                          @if (['map'].indexOf(curScreen.type)>-1) {
                            <div class="p-3">
                              <h5>Map Bindings</h5>
                              <div class="row">
                                <div class="col-sm-4">
                                  <div class="form-group mb-3">
                                    <label class="form-label">Coordinate/Location Field *</label>
                                    <select class="form-select" name="coord"
                                      [(ngModel)]="curScreen.data.coord"
                                      required>
                                      <option [ngValue]="undefined">Use longitude/latitude field...</option>
                                      @for (k of curScreen.dataset?.form?.items|keyvalue; track $index) {
                                        @if (k.value.type=='map'){
                                          <option
                                            [ngValue]="k.key"> 
                                            {{k.value.label}}
                                          </option>
                                        }
                                      }
                                    </select>
                                  </div>
                                </div>                                
                              </div>
                              @if (curScreen.data?.coord==undefined){
                                <div class="row">
                                  <div class="col-sm-4">
                                    <div class="form-group mb-3">
                                      <label class="form-label">Latitude *</label>
                                      <select class="form-select" name="lat"
                                        [(ngModel)]="curScreen.data.lat"
                                        required>
                                        <option value="" disabled>Select latitude field...
                                        </option>
                                        @for (k of curScreen.dataset?.form?.items|keyvalue; track $index) {
                                          <option
                                            [ngValue]="k.key"> 
                                            {{k.value.label}}
                                          </option>
                                        }
                                      </select>
                                    </div>
                                  </div>
                                  <div class="col-sm-4">
                                    <div class="form-group mb-3">
                                      <label class="form-label">Longitude *</label>
                                      <select class="form-select" name="lng"
                                        [(ngModel)]="curScreen.data.lng"
                                        required>
                                        <option [ngValue]="null">* Not specified</option>
                                        @for (k of curScreen.dataset?.form?.items|keyvalue; track $index) {
                                          <option
                                            [ngValue]="k.key">
                                            {{k.value.label}}
                                          </option>
                                        }
                                      </select>
                                    </div>
                                  </div>
                                  
                                </div>
                              }

                              <div class="form-group mb-3">
                                <label class="form-label">Custom Popup Content</label>
                                <div class="bg-white p-1 pb-0 var-ph-picker">
                                  @for (k of curScreen.dataset?.form?.items|keyvalue; track $index) {
                                    @if (curScreen.dataset?.form?.items[k.key].type!='static') {
                                      <button
                                        class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                      (click)="insertTextAtCursor(getItemText('$',k.value),codeeditorpopupcontent)">{{k.value.label}}</button>
                                    }
                                  }
                                  @if (curScreen.dataset?.form?.prev) {
                                    @for (k of curScreen.dataset?.form?.prev?.items|keyvalue; track $index) {
                                      @if (curScreen.dataset?.form?.prev?.items[k.key].type!='static') {
                                        <button
                                          class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                        (click)="insertTextAtCursor(getItemText('$prev$',k.value),codeeditorpopupcontent)">{{k.value.label}}</button>
                                      }
                                    }
                                  }
                                  @if (curScreen.actions) {
                                    @for (k of curScreen.actions; track k.id) {
                                      <button type="button" class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-info"
                                        (click)="insertTextAtCursor('\{\{$go[\''+k.id+'\']\}\}',codeeditorpopupcontent)">
                                        <fa-icon [icon]="['fas','cog']" [fixedWidth]="true"></fa-icon>
                                        {{k.label}}
                                      </button>
                                    }
                                  }
                                  @for (section of form.sections; track section.id) {
                                    @if (section.type=='list') {
                                      <button
                                        class="btn btn-sm small mb-1 me-1 p-1 py-0 btn-outline-secondary"
                                        (click)="insertTextAtCursor(getLoopCode(section),codeeditorpopupcontent)">
                                        <fa-icon [icon]="['fas','th']" [fixedWidth]="true"></fa-icon>
                                        {{section.title}}
                                      </button>
                                    }
                                  }
                                </div>
                                <app-cm name="codeeditorpopupcontent" lang="html" #codeeditorpopupcontent
                                  (keydown)="onKeyDown($event)"
                                  [extraAutoComplete]="extraAutoCompleteHtml"
                                  [(ngModel)]="curScreen.data.popupTpl" [linenumber]="true" required>
                                </app-cm>
                              </div>

                                <!-- @if(curScreen.data.bucketType=='custom'){ -->
                              <div class="form-group mb-3">
                                <label class="form-label">Custom Map Panel Style</label>
                                
                                <app-cm name="codeeditormapstyle" lang="html" #codeeditormapstyle
                                [placeholder]="defaultMapStyle" 
                                  (keydown)="onKeyDown($event)" subType="passive"
                                  [extraAutoComplete]="extraAutoCompleteJs"
                                  [(ngModel)]="curScreen.data.mapStyle" [linenumber]="true" required>
                                </app-cm>
                              </div>
                              <div class="form-group mb-3">
                                <label class="form-label">Custom Map Pin Icon Style</label>
                                
                                <app-cm name="codeeditormapicon" lang="html" #codeeditormapicon
                                  placeholder="Default map icon image" 
                                  (keydown)="onKeyDown($event)"
                                  [extraAutoComplete]="extraAutoCompleteHtml"
                                  [(ngModel)]="curScreen.data.icon" [linenumber]="true" required>
                                </app-cm>
                              </div>
                              <div class="form-check form-switch mt-1">
                                <input type="checkbox" class="form-check-input" [(ngModel)]="curScreen.data.readOnly"
                                  name="readOnly" id="readOnly">
                                <label class="form-check-label" for="readOnly">Read-only map</label>
                              </div>
                              <div class="form-check form-switch mt-1">
                                <input type="checkbox" class="form-check-input" [(ngModel)]="curScreen.data.fullscreen"
                                  name="fullscreen" id="fullscreen">
                                <label class="form-check-label" for="fullscreen">Full-screen map</label>
                              </div>
                              <div class="form-group mt-2">
                                <label class="form-label">Custom Map Server</label>
                                <input type="text" class="form-control" [(ngModel)]="curScreen.data.customMapServer"
                                  placeholder="Leave blank to use default (OpenStreetMap)"
                                  name="customMapServer">
                              </div>
                              <!-- @if (!curScreen.data?.readOnly){ -->
                              <div class="form-group mt-2" [class.disabled]="curScreen.data?.readOnly">
                                <label class="form-label">Drop pin on (event)</label>
                                <select class="form-select" name="dropPinOn"
                                  [(ngModel)]="curScreen.data.dropPinOn">
                                  <option [ngValue]="undefined">Use default (dblclick)</option>
                                  @for (b of ['contextmenu','click','dblclick','mousedown','mouseup']; track $index) {
                                      <option [ngValue]="b">{{b}}
                                      </option>
                                  }
                                </select>
                              </div>
                              <!-- } -->
                            </div>
                          }
                          @if (['chatbot'].indexOf(curScreen.type)>-1){                    
                  
                            <div class="p-3">
                              <div class="mb-3">Using <strong>{{curScreen.cogna?.name}} 
                                <a class="btn btn-light btn-sm float-end rounded-pill text-nowrap"
                                [routerLink]="['../../../'+app?.id+'/cogna']" [queryParams]="{id:curScreen.cogna?.id}">View Cogna</a>
                              </strong></div>
                              <h5>Chatbot configuration</h5>
                              <div class="form-group mb-3">
                                <label class="form-label">Initial greeting *</label>
                                <textarea class="form-control" 
                                  [(ngModel)]="curScreen.data.greeting" rows="4"
                                  name="greeting" id="greeting" required></textarea>
                              </div>
                              <div class="form-group mb-3">
                                <label class="form-label">Notice</label>
                                <textarea class="form-control" 
                                  [(ngModel)]="curScreen.data.notice" rows="4"
                                  name="notice" id="notice"></textarea>
                              </div>
                              <div class="form-group mb-3">
                                <label class="form-label">Logo URL</label>
                                <input type="text" class="form-control" [(ngModel)]="curScreen.data.logo"
                                  name="logo">
                              </div>
                              <div class="form-group">
                                <label class="form-label">Suggested prompt</label>
                                <div class="list-group" cdkDropList
                                  cdkDropListOrientation="vertical"
                                  (cdkDropListDropped)="dropSubs($event, curScreen.data?.suggestion)">
                                  @for (item of curScreen.data?.suggestion; track $index) {
                                    <div class="list-group-item element" cdkDrag>
                                      <span  class="element-item">
                                        @if(item.icon){
                                          <fa-icon [icon]="getIcon(item.icon)" [fixedWidth]="true"></fa-icon>
                                        }
                                        {{item?.text}}
                                      </span>
                                      <div class="element-edit nowrap"
                                        style="position:absolute;top:2px;right:2px; padding:2px">
                                        <button type="button" class="btn btn-round btn-sm my-n2 btn-secondary me-1" cdkDragHandle>
                                          <fa-icon [icon]="['fas','grip-vertical']" [fixedWidth]="true">
                                          </fa-icon>
                                        </button>
                                        <button type="button" class="btn btn-round btn-sm my-n2 btn-secondary me-1"
                                          (click)="addChatSuggestion(addChatSuggestionTpl,item)">
                                          <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true"></fa-icon>
                                        </button>
                                        <button type="button" class="btn btn-round btn-sm my-n2 btn-secondary"
                                          (click)="removeChatSuggestion($index)">
                                          <fa-icon [icon]="['fas','trash']" [fixedWidth]="true"></fa-icon>
                                        </button>
                                      </div>
                                    </div>
                                  }
                                  <div class="list-group-item">
                                    <a class="pointer d-block" (click)="addChatSuggestion(addChatSuggestionTpl,{}, true)">
                                      <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
                                      Add prompt suggestion
                                    </a>
                                  </div>
                                </div>
                              </div>                            
                            </div>
                          }
                          @if (['combine'].indexOf(curScreen.type)>-1){                    
                  
                            <div class="p-3">
                              <h5>Combined Page configuration</h5>
                              <!-- <div class="form-group mb-3">
                                <label class="form-label">Initial greeting *</label>
                                <textarea class="form-control" 
                                  [(ngModel)]="curScreen.data.greeting" rows="4"
                                  name="greeting" id="greeting" required></textarea>
                              </div>
                              <div class="form-group mb-3">
                                <label class="form-label">Notice</label>
                                <textarea class="form-control" 
                                  [(ngModel)]="curScreen.data.notice" rows="4"
                                  name="notice" id="notice"></textarea>
                              </div>
                              <div class="form-group mb-3">
                                <label class="form-label">Logo URL</label>
                                <input type="text" class="form-control" [(ngModel)]="curScreen.data.logo"
                                  name="logo">
                              </div> -->

                              <div class="form-group mb-3">
                                <label class="form-label">Nav Type *</label>
                                <div>
                                  <div class="">
                                    <input class="btn-check" type="radio" value="tabs" id="nav-tabs"
                                      name="nav-tabs" [(ngModel)]="curScreen.data.nav" required>
                                    <label for="nav-tabs" class="btn btn-outline-secondary border-2 me-1 mb-1">
                                    Tabbed</label>
                                    <input class="btn-check" type="radio" value="pills" id="nav-pills"
                                      name="nav-pills" [(ngModel)]="curScreen.data.nav"
                                      required>
                                    <label for="nav-pills" class="btn btn-outline-secondary border-2 me-1 mb-1">
                                    Pills</label>
                                    <input class="btn-check" type="radio" value="accordions" id="nav-acc"
                                      name="nav-acc" [(ngModel)]="curScreen.data.nav" required>
                                    <label for="nav-acc" class="btn btn-outline-secondary border-2 me-1 mb-1">
                                    Accordion</label>
                                  </div>
                                </div>
                              </div>

                              <div class="form-check form-switch mt-1">
                                <input type="checkbox" class="form-check-input" [(ngModel)]="curScreen.data.showIndex"
                                  name="showIndex" id="showIndex">
                                <label class="form-check-label" for="showIndex">Show Index Number</label>
                              </div>

                              <div class="form-group mt-3">
                                <label class="form-label">Components</label>
                                <div class="list-group" cdkDropList
                                cdkDropListOrientation="vertical"
                                (cdkDropListDropped)="dropSubs($event, curScreen.data?.comps)">
                                  @for (item of curScreen.data?.comps; track $index) {
                                    <div class="list-group-item element" cdkDrag>
                                      <span  class="element-item">
                                        @if(item.icon){
                                          <fa-icon [icon]="getIcon(item.icon)" [fixedWidth]="true"></fa-icon>
                                        }
                                        {{item?.title}} / {{item?.type}} / @if(item?.screenId){ {{item?.screenId}} }@else{ <span class="text-danger">Not Specified</span> }
                                      </span>
                                      <div class="element-edit nowrap"
                                        style="position:absolute;top:2px;right:2px; padding:2px">
                                        <button type="button" class="btn btn-round btn-sm my-n2 btn-secondary me-1" cdkDragHandle>
                                          <fa-icon [icon]="['fas','grip-vertical']" [fixedWidth]="true">
                                          </fa-icon>
                                        </button>
                                        <button type="button" class="btn btn-round btn-sm my-n2 btn-secondary me-1"
                                          (click)="addCombineComp(addCombineCompTpl,item)">
                                          <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true"></fa-icon>
                                        </button>
                                        <button type="button" class="btn btn-round btn-sm my-n2 btn-secondary"
                                          (click)="removeCombineComp($index)">
                                          <fa-icon [icon]="['fas','trash']" [fixedWidth]="true"></fa-icon>
                                        </button>
                                      </div>
                                    </div>
                                  }
                                  <div class="list-group-item">
                                    <a class="pointer d-block" (click)="addCombineComp(addCombineCompTpl,{}, true)">
                                      <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
                                      Add component
                                    </a>
                                  </div>
                                </div>
                              </div>                            
                            </div>
                          }
                          @if (['bucket'].indexOf(curScreen.type)>-1){                    
                  
                            <div class="p-3">
                              <div class="mb-3">Using <strong>{{curScreen.bucket?.name}} 
                                <a class="btn btn-light btn-sm float-end rounded-pill text-nowrap"
                                [routerLink]="['../../../'+app?.id+'/bucket']" [queryParams]="{id:curScreen.bucket?.id}">View Bucket</a>
                              </strong></div>
                              <h5>Bucket configuration</h5>
                              
                              <div class="form-group mb-3">
                                <label class="form-label">Type *</label>
                                <div>
                                  <div name="lang" class="text-dark">
                                    <input type="radio" class="btn-check" id="type-user" name="type-user" value="user" #type="ngModel"
                                      [(ngModel)]="curScreen.data.bucketType" [required]="true">
                                    <label for="type-user" class="btn btn-outline-secondary border-2 me-1 mb-1 text-start">
                                      User Bucket
                                      <div><small>Files by users</small></div>
                                    </label>
                                    <input type="radio" class="btn-check" id="type-all" name="type-all" value="all" #type="ngModel"
                                      [(ngModel)]="curScreen.data.bucketType" [required]="true">
                                    <label for="type-all" class="btn btn-outline-secondary border-2 me-1 mb-1 text-start">
                                      All Files
                                      <div><small>All files in bucket</small></div>
                                    </label>
                                    <input type="radio" class="btn-check" id="type-custom" name="type-custom" value="custom" #type="ngModel" 
                                      [(ngModel)]="curScreen.data.bucketType" [required]="true">
                                    <label for="type-custom" class="btn btn-outline-secondary border-2 me-2 mb-1 text-start">
                                      Custom
                                      <div><small>Custom filters</small></div>
                                    </label>
                                  </div>
                                </div>
                              </div>
                              @if(curScreen.data.bucketType=='custom'){
                                <div class="form-group mb-3">
                                  <label class="form-label">Custom Parameters</label>
                                  <app-cm name="bucketparam" lang="javascript" #codeeditorbucketparam
                                  [placeholder]="defaultBucketParam"
                                    (keydown)="onKeyDown($event)" subType="active"
                                    [extraAutoComplete]="extraAutoCompleteJs"
                                    [(ngModel)]="curScreen.data.bucketParam" [linenumber]="true" required>
                                  </app-cm>
                                </div>
                              }
                              <div class="form-check form-switch mt-1">
                                <input type="checkbox" class="form-check-input" [(ngModel)]="curScreen.data.enableUpload"
                                  name="enableUpload" id="enableUpload">
                                <label class="form-check-label" for="enableUpload">Enable file upload</label>
                              </div>
                              <div class="form-check form-switch mt-1">
                                <input type="checkbox" class="form-check-input" [(ngModel)]="curScreen.data.enableDelete"
                                  name="enableDelete" id="enableDelete">
                                <label class="form-check-label" for="enableDelete">Enable file delete</label>
                              </div>


                              <!-- <div class="form-group mb-3">
                                <label class="form-label">Notice</label>
                                <textarea class="form-control" 
                                  [(ngModel)]="curScreen.data.notice" rows="4"
                                  name="notice" id="notice"></textarea>
                              </div> -->



                              
                              <!-- <div class="form-group">
                                <label class="form-label">Suggested prompt</label>
                                <div class="list-group">
                                  @for (item of curScreen.data?.suggestion; track $index) {
                                    <div class="list-group-item element">
                                      <span  class="element-item">
                                        @if(item.icon){
                                          <fa-icon [icon]="getIcon(item.icon)" [fixedWidth]="true"></fa-icon>
                                        }
                                        {{item?.text}}
                                      </span>
                                      <div class="element-edit nowrap"
                                        style="position:absolute;top:2px;right:2px; padding:2px">
                                        <button type="button" class="btn btn-round btn-sm my-n2 btn-secondary me-1"
                                          (click)="addChatSuggestion(addChatSuggestionTpl,item)">
                                          <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true"></fa-icon>
                                        </button>
                                        <button type="button" class="btn btn-round btn-sm my-n2 btn-secondary"
                                          (click)="removeChatSuggestion($index)">
                                          <fa-icon [icon]="['fas','trash']" [fixedWidth]="true"></fa-icon>
                                        </button>
                                      </div>
                                    </div>
                                  }
                                  <div class="list-group-item">
                                    <a class="pointer d-block" (click)="addChatSuggestion(addChatSuggestionTpl,{}, true)">
                                      <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
                                      Add prompt suggestion
                                    </a>
                                  </div>
                                </div>
                              </div>                             -->
                            </div>
                          }
                          @if (['mailbox'].indexOf(curScreen.type)>-1) {
                            <div class="fs-5 text-muted p-3 text-center">Nothing to be configured</div>
                          }
                        </ng-template>
                      </li>
                    }
                    @if (['static','list','page','calendar','chatbot','bucket','map','mailbox','combine'].indexOf(curScreen.type)>-1) {
                      <li ngbNavItem>
                        <a class="small px-2" ngbNavLink>Pre</a>
                        <ng-template ngbNavContent>
                          <div class="bg-white p-1 pb-0 var-ph-picker">
                            @if (curScreen.actions) {
                              @for (k of curScreen.actions; track k.id) {
                                <button type="button" class="btn btn-sm small mb-1 me-1 p-1 btn-outline-info"
                                  (click)="insertTextAtCursor('\{\{$go[\''+k.id+'\']\}\}',codeeditorpre())">
                                  <fa-icon [icon]="['fas','cog']" [fixedWidth]="true"></fa-icon>
                                  {{k.label}}
                                </button>
                              }
                            }
                          </div>
                        
                          @if (showWysiwyg) {
                            <angular-editor [config]="editorConfig" name="pretext"
                              class="sc-ae"
                              [class.ae-limit-width]="!curScreen?.wide"
                            [(ngModel)]="curScreen.data.pretext"></angular-editor>
                          } @else {
                            <app-cm name="pretext" lang="html" #codeeditorpre
                              (keydown)="onKeyDown($event)"
                              [(ngModel)]="curScreen.data.pretext" [linenumber]="true">
                            </app-cm>
                          }
                        </ng-template>
                      </li>
                    }
                    @if (['static','list','page','calendar','chatbot','bucket','map','mailbox','combine'].indexOf(curScreen.type)>-1) {
                      <li ngbNavItem>
                        <a class="small px-2" ngbNavLink>Post</a>
                        <ng-template ngbNavContent>
                          <div class="bg-white p-1 pb-0 var-ph-picker">
                            @if (curScreen.actions) {
                              @for (k of curScreen.actions; track k.id) {
                                <button type="button" class="btn btn-sm small mb-1 me-1 p-1 btn-outline-info"
                                  (click)="insertTextAtCursor('\{\{$go[\''+k.id+'\']\}\}',codeeditorpost())">
                                  <fa-icon [icon]="['fas','cog']" [fixedWidth]="true"></fa-icon>
                                  {{k.label}}
                                </button>
                              }
                            }
                          </div>
                          @if (showWysiwyg) {
                            <angular-editor (keydown)="onKeyDown($event)"
                              class="sc-ae"
                              [config]="editorConfig" [class.ae-limit-width]="!curScreen?.wide"
                              name="posttext" [(ngModel)]="curScreen.data.posttext">
                            </angular-editor>
                          }
                          @if (!showWysiwyg) {
                            <app-cm name="posttext" lang="html" #codeeditorpost
                              (keydown)="onKeyDown($event)"
                              [(ngModel)]="curScreen.data.posttext" [linenumber]="true">
                            </app-cm>
                          }
                        </ng-template>
                      </li>
                    }
                    <li ngbNavItem [disabled]="['list','page','static','combine','map','qr'].indexOf(curScreen.type)==-1">
                      <a class="small px-2" ngbNavLink>Init &fnof;</a>
                      <ng-template ngbNavContent>
                        @if (curScreen.id) {
                          <div class="mt-1">
                            <app-cm name="init" lang="javascript" #codeeditorinit
                              (keydown)="onKeyDown($event)" subType="active"
                              [extraAutoComplete]="extraAutoCompleteJs"
                              [(ngModel)]="curScreen.data.f" [linenumber]="true">
                            </app-cm>
                          </div>
                        }
                      </ng-template>
                    </li>
                    <!-- <li ngbNavItem [disabled]="['chatbot','qr'].indexOf(curScreen.type)>-1">
                      <a class="small px-2" ngbNavLink>Preview</a>
                      <ng-template ngbNavContent>
                        <div class="p-2">
                          @if (curScreen.type=='static') {
                            <div class="p-3 bg-light" [innerHtml]="compileTpl(curScreen?.data?.content, {$_:{},$:{},$prev$:{},$$_:{},$maps$:[],$go:{},$popup:{},$param$:$param$,$this$:$this$,$user$:user, $conf$:runService.appConfig,$base$:base,$baseUrl$:baseUrl,$baseApi$:baseApi})|safe:'html'"></div>
                          }
                          @if (curScreen.type=='page') {
                            <div class="bg-white mb-2">
                              <div class="input-group">
                                <span class="input-group-text">Test ID</span>
                                <input type="text" class="form-control" name="test-id" #testId>
                                <button type="button" class="btn btn-secondary"
                                (click)="runPreview(curScreen.type, testId.value)">Run</button>
                              </div>
                            </div>
                            @if (curPreviewPage.$id) {
                              <div class="p-3 bg-light" [ngClass]="curScreen?.data?.parentclass"
                                [innerHtml]="compileTpl(curScreen?.data?.content,{$:curPreviewPage,$$:curPreviewPage.$prev,$go:{}})|safe:'html'">
                              </div>
                            }
                          }
                          @if (['list','calendar'].indexOf(curScreen.type)>-1) {
                            <div class="bg-white mb-2">
                              <button type="button" class="btn btn-sm btn-round px-3 btn-secondary"
                              (click)="runPreview(curScreen.type, null)">Run Page</button>
                            </div>
                            <div class="p-3 bg-light">
                              <div [outerHTML]="curScreen?.data?.pretext"></div>
                              @if (['list'].indexOf(curScreen.type)>-1) {
                                <div [ngClass]="curScreen?.data?.parentclass">
                                  @for (entry of curPreviewList; track entry.id) {
                                    <div
                                      [outerHTML]="compileTpl(curScreen?.data?.content,{$:entry,$$:entry.$prev,$go:{}})|safe:'html'">
                                    </div>
                                  }
                                  @if (curPreviewList.length==0) {
                                    <div class="p-3 text-muted bg-light d-flex align-items-center">
                                      <h5>No entry available</h5>
                                    </div>
                                  }
                                </div>
                              }
                              @if (['calendar'].indexOf(curScreen.type)>-1) {
                                <div>
                                  <full-calendar [options]="{
                                    initialView: curScreen?.data?.defaultView,
                                    weekends: true,
                                    header: {
                                    center: 'title',
                                    left: 'filter,dayGridMonth,timeGridWeek,timeGridDay',
                                    right: 'prev,next,today'
                                    },
                                    buttonText: {
                                    today:    'T',
                                    month:    'M',
                                    week:     'W',
                                    day:      'D',
                                    list:     'list'
                                    },
                                    plugins: calendarPlugins,
                                    events: entryEvent
                                  }" deepChangeDetection="true"></full-calendar>
                                </div>
                              }
                              <div [outerHTML]="curScreen?.data?.posttext"></div>
                            </div>
                          }
                        </div>
                      </ng-template>
                    </li> -->
                  </ul>
                </div>
                <div [ngbNavOutlet]="nav"></div>
                <div class="card-footer">
                  <div class="form-check form-switch mb-1">
                    <input class="form-check-input" type="checkbox" id="showWysiwyg"
                      [(ngModel)]="showWysiwyg" name="showWysiwyg" [disabled]="['chatbot','qr','map','combine','mailbox'].indexOf(curScreen.type)>-1">
                    <label class="form-check-label" for="showWysiwyg">Show Visual Editor</label>
                  </div>
                </div>
              </div>
            </form>
            <button type="button" class="my-2 btn btn-primary btn-round" [disabled]="contentForm.pristine"
              (click)="saveScreen(curScreen, contentForm)">
              <fa-icon [icon]="['fas','save']" [fixedWidth]="true"></fa-icon>
              Save Content
            </button>
          </div>
        }
        
        <div class="mb-2">
          <label class="form-label">Actions</label>
          @if (curScreen.actions.length==0) {
            <div class="text-muted pb-3">No actions specified</div>
          }
          @if (curScreen.actions.length>0) {
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Label</th>
                  <th>Action</th>
                  <th style="width: 5%"></th>
                </tr>
              </thead>
              <tbody>
                @for (ac of curScreen.actions; track ac.id) {
                  <tr>
                    <td><span style="font-size:1.5em; line-height: 1em;">{{ac.id}}</span></td>
                  <!-- <div class="btn btn-sm btn-outline-secondary btn-round"></div> -->
                  <td>{{ac.label}}</td>
                  <td>
                    @if (ac.nextType=='view') {
                      <div>
                        <div class="d-inline">View
                          <strong>{{actionComps.forms?.[ac.next]?.title}}</strong> Entry
                        </div>
                      </div>
                    }
                    @if (ac.nextType=='view-single') {
                      <div>
                        <div class="d-inline">View Single
                          <strong>{{actionComps.forms?.[ac.next]?.title}}</strong> Entry
                        </div>
                      </div>
                    }
                    @if (ac.nextType=='form') {
                      <div>
                        <div class="d-inline">Open
                          <strong>{{actionComps.forms?.[ac.next]?.title}}</strong> Form
                        </div>
                      </div>
                    }
                    @if (ac.nextType=='facet') {
                      <div>
                        <div class="d-inline">Open 
                          <strong>{{ac.x?.nextFacet}}</strong> in {{actionComps.forms?.[ac.next]?.title}}
                        </div>
                      </div>
                    }
                    @if (ac.nextType=='edit') {
                      <div>
                        <div class="d-inline">Edit
                          <strong>{{actionComps.forms?.[ac.next]?.title}}</strong> Entry
                        </div>
                      </div>
                    }
                    @if (ac.nextType=='edit-single') {
                      <div>
                        <div class="d-inline">Edit Single
                          <strong>{{actionComps.forms?.[ac.next]?.title}}</strong> Entry
                        </div>
                      </div>
                    }
                    @if (ac.nextType=='prev') {
                      <div>
                        <div class="d-inline">New Entry for
                          <strong>{{actionComps.forms?.[ac.next]?.title}}</strong>
                        </div>
                      </div>
                    }
                    @if (ac.nextType=='screen') {
                      <div>
                        <div class="d-inline">View Entry in
                          <strong>{{actionComps.screens?.[ac.next]?.title}}</strong>
                        </div>
                      </div>
                    }
                    @if (ac.nextType=='static') {
                      <div>
                        <div class="d-inline">Open
                          <strong>{{actionComps.screens?.[ac.next]?.title}}</strong>
                        </div>
                      </div>
                    }
                    @if (ac.nextType=='dataset') {
                      <div>
                        <div class="d-inline">Open
                          <strong>{{actionComps.datasets?.[ac.next]?.title}}</strong>
                        </div>
                      </div>
                    }
                    @if (ac.nextType=='dashboard') {
                      <div>
                        <div class="d-inline">Open
                          <strong>{{actionComps.dashboards?.[ac.next]?.title}}</strong>
                        </div>
                      </div>
                    }
                  </td>
                  <td class="text-nowrap">
                    <button type="button" class="btn btn-round btn-sm my-n2 btn-secondary me-1"
                      (click)="editAction(editActionTpl,ac)">
                      <fa-icon [icon]="['fas','pencil-alt']" [fixedWidth]="true"></fa-icon>
                    </button>
                    <button type="button" class="btn btn-round btn-sm my-n2 btn-secondary"
                      (click)="removeAction(removeActionTpl,ac)">
                      <fa-icon [icon]="['fas','trash']" [fixedWidth]="true"></fa-icon>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
            </table>
          }
          <button type="button" class="btn btn-round btn-secondary" (click)="editAction(editActionTpl,{})">Add Action</button>
        </div>
      </div>
    } @else {
      <div class="m-a col-sm-12" style="color:#aaa;">
        <div class="p-4 text-muted text-center">
          <h4>Please select screen to edit</h4>
        </div>
      </div>
    }
  </div>
</div>

<ng-template #editActionTpl let-c="close" let-d="dismiss">
  <div #editActionForm="ngForm" ngForm>
    <div class="modal-header">
      <h4 class="modal-title">Edit Action</h4>
    </div>
    <div class="modal-body">
      <div class="form-group mb-3">
        <label class="form-label">Label</label>
        <input type="text" class="form-control" [(ngModel)]="editActionData.label"
          name="label">
        </div>
        <div class="form-group mb-3">
          <label class="form-label">Action Type</label>
          <select class="form-select" name="nextType" [(ngModel)]="editActionData.nextType"
            required>
            <option value="" disabled>Select action...</option>
            <option value="edit" [disabled]="[''].indexOf(curScreen.type)>-1">Edit Current Entry</option>
            <option value="edit-single" [disabled]="[''].indexOf(curScreen.type)>-1">Edit Single</option>
            <option value="prev" [disabled]="[''].indexOf(curScreen.type)>-1">Insert Entry of Target Form</option>
            <option value="view" [disabled]="[''].indexOf(curScreen.type)>-1">View Entry</option>
            <option value="view-single" [disabled]="[''].indexOf(curScreen.type)>-1">View Single</option>
            <option value="screen" [disabled]="[''].indexOf(curScreen.type)>-1">View Entry in
            Screen</option>
            <option value="form">Open Form</option>
            <option value="facet">Open in Facet</option>
            <option value="static">Open Static/Entry Page Screen</option>
            <option value="dataset">Open Dataset</option>
            <option value="dashboard">Open Dashboard</option>
            <option value="lookup">Open Lookup</option>
            <option value="user">Open Manage User</option>
            @if (curScreen.type=='qr'){
              <option value="function">Run function</option>
            }
          </select>
          @if (curScreen.type=='static' && ['edit','prev','view','screen'].indexOf(editActionData?.nextType)>-1) {
            <div class="small text-muted mt-1"
              >
            Entry ID must be appended to the action link ie: {{'{'}}{{'{'}}go['100']{{'}'}}{{'}'}}1234</div>
          }
        </div>
        @if (['function'].indexOf(editActionData.nextType)>-1) {
          <div class="form-group mb-3">
            <label class="form-label">Function</label>
            <div class="mx-n2">
              <app-cm name="f" lang="javascript" [(ngModel)]="editActionData.f"
                [extraAutoComplete]="extraAutoCompleteJs" subType="active"
                placeholder="ie: $update($.$id,{'_submittedOn':Date.now()})"
                [linenumber]="true">
              </app-cm>
            </div>
          </div>
        }@else {
          @if (editActionData.nextType) {
            <div class="form-group mb-3">
              <label class="form-label">Select App *</label>
              <select class="form-select" name="appId" (change)="loadOtherAppList(editActionData.appId)"
                [(ngModel)]="editActionData.appId">
                @for (app of otherAppList; track app.id) {
                  <option [ngValue]="app.id">{{app.title}}</option>
                }
              </select>
            </div>
          }
          @if (['edit','view','form','prev','edit-single','view-single','facet'].indexOf(editActionData.nextType)>-1) {
            <div class="form-group mb-3">
              <label class="form-label">Action Target</label>
              <select class="form-select" name="next" [(ngModel)]="editActionData.next" (change)="loadFacet(editActionData.next)" required>
                <option value="" disabled>Select form...</option>
                @for (item of formList; track item.id) {
                  <option [value]="item.id" >{{item.title}}</option>
                }
              </select>
            </div>
            @if (['facet'].indexOf(editActionData.nextType)>-1) {
              <div class="form-group mb-3">
                <label class="form-label">Next facet *</label>
                <select class="form-select" name="nextFacet"
                  [(ngModel)]="editActionData.x.nextFacet" required>
                  <option value="" disabled>Select facet...</option>
                  @for (item of facetList; track item) {
                    <option
                    [value]="item">{{item}}</option>
                  }
                </select>
              </div>
            }
          }@else if (['screen','static'].indexOf(editActionData.nextType)>-1) {
            <div class="form-group mb-3">
              <label class="form-label">Action Target</label>
              <select class="form-select" name="next" [(ngModel)]="editActionData.next" required>
                <option value="" disabled>Select screen...</option>
                @for (item of screenList; track item.id) {
                  <option [value]="item.id">{{item.title}}</option>
                }
              </select>
            </div>
          }@else if (['dataset'].indexOf(editActionData.nextType)>-1) {
            <div class="form-group mb-3">
              <label class="form-label">Action Target</label>
              <select class="form-select" name="next" [(ngModel)]="editActionData.next" required>
                <option value="" disabled>Select dataset...</option>
                @for (item of datasetList; track item.id) {
                  <option [value]="item.id">{{item.title}}</option>
                }
              </select>
            </div>
          }@else if (['dashboard'].indexOf(editActionData.nextType)>-1) {
            <div class="form-group mb-3">
              <label class="form-label">Action Target</label>
              <select class="form-select" name="next" [(ngModel)]="editActionData.next" required>
                <option value="" disabled>Select dashboard...</option>
                @for (item of dashboardList; track item.id) {
                  <option [value]="item.id">{{item.title}}</option>
                }
              </select>
            </div>
          }@else if (['lookup'].indexOf(editActionData.nextType)>-1) {
            <div class="form-group mb-3">
              <label class="form-label">Action Target</label>
              <select class="form-select" name="next" [(ngModel)]="editActionData.next" required>
                <option value="" disabled>Select lookup...</option>
                @for (item of lookupList; track item.id) {
                  <option [value]="item.id">{{item.name}}</option>
                }
              </select>
            </div>
          }@else if (['user'].indexOf(editActionData.nextType)>-1) {
            <div class="form-group mb-3">
              <label class="form-label">Action Target</label>
              <select class="form-select" name="next" [(ngModel)]="editActionData.next" required>
                <option value="" disabled>Select lookup...</option>
                @for (item of accessList; track item.id) {
                  <option [value]="item.id">{{item.name}}</option>
                }
              </select>
            </div>
          }

          @if (editActionData.nextType){
            <div class="form-group mb-3">
              <label class="form-label">Parameters ($code$ as QR Code placeholder)</label>
              <div class="mx-n2">
                <app-cm name="params" lang="javascript" hideControl="true" #paramseditor
                  [(ngModel)]="editActionData.params" [linenumber]="true">
                </app-cm>
              </div>
            </div>
          }

        }



        
        
        <!-- @if (['function'].indexOf(editActionData.nextType)==-1){
          <div class="form-group mb-3">
            <label class="form-label">Function</label>
            <div class="mx-n2">
              <app-cm name="f" lang="javascript" hideControl="true" #feditor
                [(ngModel)]="editActionData.f" [linenumber]="true">
              </app-cm>
            </div>
          </div>          
        } -->
    </div>
    <div class="modal-footer justify-content-between">
      <button type="button" class="btn btn-round btn-secondary" (click)="d()">Close</button>
      <button type="button" class="btn btn-round btn-primary" [disabled]="editActionForm.invalid"
        (click)="c(editActionData)">
        <fa-icon [icon]="['fas','plus']" [fixedWidth]="true"></fa-icon>
        Save Action
      </button>
    </div>
  </div>
</ng-template>

<ng-template #editScreenTpl let-c="close" let-d="dismiss">
  @defer(prefetch on idle){
    <app-edit-screen [dismiss]="d" [close]="c" [screen]="editScreenData" [formList]="formList"
    [cognaList]="cognaList" [datasetList]="datasetList" [accessList]="accessList" 
    [bucketList]="bucketList"></app-edit-screen>
  }@loading {
    <div class="text-center m-5">
      <div class="spinner-grow text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }
</ng-template>

<ng-template #removeScreenTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Remove Screen</h4>
  </div>
  <div class="modal-body">
    <p>
      Are you sure you want to remove this screen?
    </p>
    <div class="form">
      <div class="form-group mb-3">
        <label class="form-label">Screen Title</label>
        <p class="form-control-static">
          {{removeScreenData.title}}
        </p>
      </div>
    </div>
  </div>
  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round btn-secondary" (click)="d()">Close</button>
    <button type="button" class="btn btn-round btn-primary" (click)="c(removeScreenData)">
      Remove Screen
    </button>
  </div>
</ng-template>

<ng-template #removeActionTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Remove Action</h4>
  </div>
  <div class="modal-body">
    <p>
      Are you sure you want to remove this action?
    </p>
    <div class="form">
      <div class="form-group mb-3">
        <label class="form-label">Action Label</label>
        <p class="form-control-static">
          {{removeActionData.label}}
        </p>
      </div>
    </div>
  </div>
  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round btn-secondary" (click)="d()">Close</button>
    <button type="button" class="btn btn-round btn-primary" (click)="c(removeActionData)">
      Remove Action
    </button>
  </div>
</ng-template>

<ng-template #addChatSuggestionTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Add Prompt Suggestion</h4>
  </div>
  <div class="modal-body">
    <div class="form">
      <div class="form-group mb-3">
        <label class="form-label">Chat text</label>
        <input type="text" class="form-control" [(ngModel)]="chatSuggestData.text"
          name="text">
      </div>
      <div class="form-group mb-3">
        <label class="form-label">Icon</label>
        <app-icon-picker [(model)]="chatSuggestData.icon" [showNone]="true"></app-icon-picker>
      </div>
    </div>
  </div>
  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round btn-secondary" (click)="d()">Close</button>
    <button type="button" class="btn btn-round btn-primary" (click)="c(chatSuggestData)">
      Add Suggestion
    </button>
  </div>
</ng-template> 
<ng-template #addCombineCompTpl let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Add Component</h4>
  </div>
  <div class="tab-simple" #addCombineCompForm="ngForm" ngForm>
    <ul ngbNav #nav="ngbNav" [destroyOnHide]="false" class="nav-tabs justify-content-center">
      <li ngbNavItem>
        <a ngbNavLink>Component</a>
        <ng-template ngbNavContent>
          <div class="single-pane">

            <div class="form-group mb-3">
              <label class="form-label">Label</label>
              <input type="text" class="form-control" [(ngModel)]="addCombineCompData.title"
                name="text">
            </div>
            
            <div class="form-group mb-3">
              <label class="form-label">Component Type</label>
              <div>
                <div class="form-check">
                  <input type="radio" class="form-check-input" id="type-add" name="type"
                    [(ngModel)]="addCombineCompData.type" value="add" required>
                  <label for="type-form" class="form-check-label">Add</label>
                </div>
                <div class="form-check">
                  <input type="radio" class="form-check-input" id="type-form-single" name="type"
                    [(ngModel)]="addCombineCompData.type" value="form-single" required>
                  <label for="type-form-single" class="form-check-label">Form Single</label>
                </div>
                <div class="form-check">
                  <input type="radio" class="form-check-input" id="type-view-single" name="type"
                    [(ngModel)]="addCombineCompData.type" value="view-single" required>
                  <label for="type-view-single" class="form-check-label">View Single</label>
                </div>
                <div class="form-check">
                  <input type="radio" class="form-check-input" id="type-dataset" name="type"
                    [(ngModel)]="addCombineCompData.type" value="dataset" required>
                  <label for="type-dataset" class="form-check-label">Dataset</label>
                </div>
                <div class="form-check">
                  <input type="radio" class="form-check-input" id="type-dashboard" name="type"
                    [(ngModel)]="addCombineCompData.type" value="dashboard" required>
                  <label for="type-dashboard" class="form-check-label">Dashboard</label>
                </div>
                <div class="form-check">
                  <input type="radio" class="form-check-input" id="type-screen" name="type"
                    [(ngModel)]="addCombineCompData.type" value="screen" required>
                  <label for="type-screen" class="form-check-label">Screen</label>
                </div>
                <div class="form-check">
                  <input type="radio" class="form-check-input" id="type-lookup" name="type"
                    [(ngModel)]="addCombineCompData.type" value="lookup" required>
                  <label for="type-lookup" class="form-check-label">Lookup</label>
                </div>
                <!-- <div class="form-check">
                  <input type="radio" class="form-check-input" id="type-external" name="type"
                    [(ngModel)]="editItemData.type" value="external" required>
                  <label for="type-external" class="form-check-label">External URL</label>
                </div>
                <div class="form-check">
                  <input type="radio" class="form-check-input" id="type-internal" name="type"
                    [(ngModel)]="editItemData.type" value="internal" required>
                  <label for="type-internal" class="form-check-label">Internal URL</label>
                </div> -->
                <div class="form-check">
                  <input type="radio" class="form-check-input" id="type-user" name="type"
                    [(ngModel)]="addCombineCompData.type" value="user" required>
                  <label for="type-user" class="form-check-label">User Group</label>
                </div>
      
      
      
      
      
              </div>
            </div>

            @if (['form','form-single','view-single','dataset','dashboard','lookup','screen','user'].indexOf(addCombineCompData.type)>-1) {
              <div class="form-group mb-3">
                <label class="form-label">Select App</label>
                <select class="form-select" name="appId"
                  (change)="loadOtherAppList(addCombineCompData.type,addCombineCompData.appId)"
                  [(ngModel)]="addCombineCompData.appId">
                  @for (app of otherAppList; track app.id) {
                    <option [ngValue]="app.id">{{app.title}}</option>
                  }
                </select>
              </div>
            }
      
      
            @if (['add','form-single','view-single'].indexOf(addCombineCompData.type)>-1) {
              <div class="form-group mb-3"
                >
                <label class="form-label">Select Form *</label>
                <select class="form-select" name="screenId"
                  [(ngModel)]="addCombineCompData.screenId" required>
                  <option value="" disabled>Select form...</option>
                  @for (form of formList; track form.id) {
                    <option [value]="form.id">{{form.title}} [{{form.id}}]
                    </option>
                  }
                </select>
              </div>
            }
            @if (addCombineCompData.type=='dataset') {
              <div class="form-group mb-3">
                <label class="form-label">Select Dataset *</label>
                <select class="form-select" name="screenId"
                  [(ngModel)]="addCombineCompData.screenId" required>
                  <option value="" disabled>Select dataset...</option>
                  @for (dataset of datasetList; track dataset.id) {
                    <option [value]="dataset.id">{{dataset.title}}
                      [{{dataset.id}}]
                    </option>
                  }
                </select>
              </div>
            }
            @if (addCombineCompData.type=='dashboard') {
              <div class="form-group mb-3">
                <label class="form-label">Select Dashboard *</label>
                <select class="form-select" name="screenId"
                  [(ngModel)]="addCombineCompData.screenId" required>
                  <option value="" disabled>Select dashboard...</option>
                  @for (dashboard of dashboardList; track dashboard.id) {
                    <option [value]="dashboard.id">
                    {{dashboard.title}} [{{dashboard.id}}]</option>
                  }
                </select>
              </div>
            }
            @if (addCombineCompData.type=='screen') {
              <div class="form-group mb-3">
                <label class="form-label">Select Screen *</label>
                <select class="form-select" name="screenId"
                  [(ngModel)]="addCombineCompData.screenId" required>
                  <option value="" disabled>Select custom screen...</option>
                  @for (screen of screenList; track screen.id) {
                    <option [value]="screen.id">{{screen.title}}
                      [{{screen.id}}]
                    </option>
                  }
                </select>
              </div>
            }
            @if (addCombineCompData.type=='lookup') {
              <div class="form-group mb-3">
                <label class="form-label">Select Lookup *</label>
                <select class="form-select" name="screenId"
                  [(ngModel)]="addCombineCompData.screenId" required>
                  <option value="" disabled>Select lookup...</option>
                  @for (lookup of lookupList; track lookup.id) {
                    <option [value]="lookup.id">{{lookup.name}}
                      [{{lookup.id}}]
                    </option>
                  }
                </select>
              </div>
            }

            @if (addCombineCompData.type=='user') {
              <div class="form-group mb-3">
                <label class="form-label">Select Group *</label>
                <select class="form-select" name="screenId"
                  [(ngModel)]="addCombineCompData.screenId">
                  <option value="" disabled>Select group...</option>
                  <option [ngValue]="undefined">All Group</option>
                  @for (group of accessList; track group.id) {
                    <option [value]="group.id">{{group.name}}
                      [{{group.id}}]
                    </option>
                  }
                </select>
              </div>
            }



          </div>
        </ng-template>
      </li>
      <li ngbNavItem>
        <a ngbNavLink>Icon</a>
        <ng-template ngbNavContent>
          <div class="single-pane">
            <!-- <div class="form-group mb-3">
              <label class="form-label">Icon</label> -->
              <app-icon-picker [(model)]="addCombineCompData.icon" [showNone]="true"></app-icon-picker>
            <!-- </div> -->
          </div>
        </ng-template>
      </li>
    </ul>
    <div [ngbNavOutlet]="nav"></div>
  </div>
  <div class="modal-footer justify-content-between">
    <button type="button" class="btn btn-round btn-secondary" (click)="d()">Close</button>
    <button type="button" class="btn btn-round btn-primary" [disabled]="addCombineCompForm.invalid" (click)="c(addCombineCompData)">
      Save Component
    </button>
  </div>
</ng-template> 